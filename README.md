# 番茄小说下载器

[![GitHub release](https://img.shields.io/github/release/POf-L/Fanqie-novel-Downloader.svg)](https://github.com/POf-L/Fanqie-novel-Downloader/releases)
[![GitHub stars](https://img.shields.io/github/stars/POf-L/Fanqie-novel-Downloader.svg)](https://github.com/POf-L/Fanqie-novel-Downloader)
[![GitHub license](https://img.shields.io/github/license/POf-L/Fanqie-novel-Downloader.svg)](https://github.com/POf-L/Fanqie-novel-Downloader/blob/main/LICENSE)
[![Build Status](https://github.com/POf-L/Fanqie-novel-Downloader/workflows/Build%20and%20Release/badge.svg)](https://github.com/POf-L/Fanqie-novel-Downloader/actions)
<a href="https://deepwiki.com/POf-L/Fanqie-novel-Downloader"><img src="https://img.shields.io/badge/DeepWiki-POf--L%2FFanqie--novel--Downloader-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAyCAYAAAAnWDnqAAAAAXNSR0IArs4c6QAAA05JREFUaEPtmUtyEzEQhtWTQyQLHNak2AB7ZnyXZMEjXMGeK/AIi+QuHrMnbChYY7MIh8g01fJoopFb0uhhEqqcbWTp06/uv1saEDv4O3n3dV60RfP947Mm9/SQc0ICFQgzfc4CYZoTPAswgSJCCUJUnAAoRHOAUOcATwbmVLWdGoH//PB8mnKqScAhsD0kYP3j/Yt5LPQe2KvcXmGvRHcDnpxfL2zOYJ1mFwrryWTz0advv1Ut4CJgf5uhDuDj5eUcAUoahrdY/56ebRWeraTjMt/00Sh3UDtjgHtQNHwcRGOC98BJEAEymycmYcWwOprTgcB6VZ5JK5TAJ+fXGLBm3FDAmn6oPPjR4rKCAoJCal2eAiQp2x0vxTPB3ALO2CRkwmDy5WohzBDwSEFKRwPbknEggCPB/imwrycgxX2NzoMCHhPkDwqYMr9tRcP5qNrMZHkVnOjRMWwLCcr8ohBVb1OMjxLwGCvjTikrsBOiA6fNyCrm8V1rP93iVPpwaE+gO0SsWmPiXB+jikdf6SizrT5qKasx5j8ABbHpFTx+vFXp9EnYQmLx02h1QTTrl6eDqxLnGjporxl3NL3agEvXdT0WmEost648sQOYAeJS9Q7bfUVoMGnjo4AZdUMQku50McDcMWcBPvr0SzbTAFDfvJqwLzgxwATnCgnp4wDl6Aa+Ax283gghmj+vj7feE2KBBRMW3FzOpLOADl0Isb5587h/U4gGvkt5v60Z1VLG8BhYjbzRwyQZemwAd6cCR5/XFWLYZRIMpX39AR0tjaGGiGzLVyhse5C9RKC6ai42ppWPKiBagOvaYk8lO7DajerabOZP46Lby5wKjw1HCRx7p9sVMOWGzb/vA1hwiWc6jm3MvQDTogQkiqIhJV0nBQBTU+3okKCFDy9WwferkHjtxib7t3xIUQtHxnIwtx4mpg26/HfwVNVDb4oI9RHmx5WGelRVlrtiw43zboCLaxv46AZeB3IlTkwouebTr1y2NjSpHz68WNFjHvupy3q8TFn3Hos2IAk4Ju5dCo8B3wP7VPr/FGaKiG+T+v+TQqIrOqMTL1VdWV1DdmcbO8KXBz6esmYWYKPwDL5b5FA1a0hwapHiom0r/cKaoqr+27/XcrS5UwSMbQAAAABJRU5ErkJggg==" alt="DeepWiki"></a>
<!-- DeepWiki badge generated by https://deepwiki.ryoppippi.com/ -->

一个现代化、高效的番茄小说下载器，使用 Python 构建，配备简洁、响应式的网页界面。

## ✨ 功能特性

- 📚 **图书搜索**: 轻松按标题或作者搜索图书
- 📦 **批量下载**: 一次下载多本图书
- 📄 **格式支持**: 导出为 **TXT**（纯文本）或 **EPUB**（电子书）格式
- 🖼️ **封面图片**: 自动获取并在 EPUB 文件中嵌入图书封面
- 📖 **章节选择**: 下载完整图书、特定范围或手动选择的章节
- 🌐 **跨平台**: 支持 Windows、macOS、Linux 和 Termux（Android）
- ☁️ **GitHub Actions 云端下载**: 无需本地环境，直接在 GitHub 云端批量下载小说

## 🚀 快速开始

### 方式一：GitHub Actions 云端下载 ☁️ (推荐)

**无需安装任何软件，直接在 GitHub 云端下载小说！**

👉 [**查看云端下载指南**](docs/CLOUD_DOWNLOAD.md)

**适用场景：**
- 不想安装任何软件
- 偶尔下载几本小说
- 没有稳定的本地环境
- 需要在服务器上批量下载

### 方式二：本地安装使用

👉 [**查看本地安装指南**](docs/LOCAL_INSTALLATION.md)

**适用场景：**
- 频繁下载小说
- 需要自定义配置
- 离线使用
- 批量管理大量书籍

### 方式三：Docker 部署 🐳

```bash
# 拉取镜像
docker pull pofl/fanqie-novel-downloader:latest

# 运行容器
docker run -d -p 5000:5000 -v ~/novels:/app/novels pofl/fanqie-novel-downloader

# 访问 Web 界面
open http://localhost:5000
```

**适用场景：**
- 服务器部署
- 容器化环境
- 需要隔离运行环境

## 📖 文档导航

| 文档 | 描述 |
| :--- | :--- |
| [📋 README.md](README.md) | 项目概览和快速开始 |
| [☁️ CLOUD_DOWNLOAD.md](docs/CLOUD_DOWNLOAD.md) | GitHub Actions 云端下载详细指南 |
| [💻 LOCAL_INSTALLATION.md](docs/LOCAL_INSTALLATION.md) | 本地安装和使用指南 |
| [🤝 CONTRIBUTING.md](docs/CONTRIBUTING.md) | 贡献指南和开发说明 |
| [🔧 NODE_MANAGEMENT.md](docs/NODE_MANAGEMENT.md) | 节点管理和故障恢复说明 |

## 🔄 发布版云同步说明

- 仅 GitHub Actions 打包发布版在启动时执行云同步，源码直接运行不触发。
- 发布流程会自动生成并上传 `runtime-manifest.json`（每文件含 `version`、`sha256`、`url`、`size`）。
- 同步范围由 `config/cloud_sync_paths.json` 维护，可独立调整，无需改脚本代码。
- 客户端同步逻辑位于 `utils/cloud_sync.py`，支持更新/新增/删除、缓存回退、备份回滚与路径安全校验。

## 🚀 Launcher + Runtime（正式架构）

- 发布产物分为两层：
  - `Launcher`：稳定启动器（跨平台），负责检查/下载/校验/回滚 Runtime
  - `Runtime`：按平台发布的运行时压缩包，包含业务代码与依赖（`.venv`）
- 启动流程：
  1. 启动 Launcher
  2. 拉取 `runtime-manifest-<platform>.json`
  3. 比较本地 Runtime 版本与 sha256
  4. 需要更新则下载 `runtime-<platform>.zip` 并原子替换（失败回滚）
  5. 启动 Runtime 中的 `main.py`
- 从此以后，常规更新只需发布 Runtime，不必每次重发 Launcher。
- 启动器下载建议使用固定通道 `launcher-stable`（仅在启动器协议升级时更新）。

## 📱 Termux 用户

- Termux 安装与故障排除请查看：[`docs/TERMUX_GUIDE.md`](docs/TERMUX_GUIDE.md)
- 若出现 `cannot execute: required file not found`，请重新下载 release 中的 `TomatoNovelDownloader-termux-arm64`（当前为脚本入口）

## 🎯 使用示例

### Web 界面快速上手

1. **启动程序**
   ```bash
   # 下载可执行文件后直接运行
   ./TomatoNovelDownloader
   
   # 或使用源代码
   python main.py
   ```

2. **搜索书籍**
   - 在搜索框输入书名或作者名
   - 例如："斗破苍穹" 或 "天蚕土豆"
   - 点击搜索按钮或按 Enter 键

3. **下载书籍**
   - 从搜索结果中选择书籍
   - 选择输出格式（TXT/EPUB）
   - 点击下载按钮
   - 等待下载完成

### CLI 命令行示例

```bash
# 搜索书籍
python core/cli.py search "斗破苍穹"

# 查看书籍详情
python core/cli.py info 7372503659137005093

# 下载单本书籍（TXT 格式）
python core/cli.py download 7372503659137005093 --format txt

# 下载单本书籍（EPUB 格式，包含封面）
python core/cli.py download 7372503659137005093 --format epub

# 批量下载多本书籍
python core/cli.py batch-download 7372503659137005093 7372528691033300280 --format epub

# 下载指定章节范围
python core/cli.py download 7372503659137005093 --chapter-start 1 --chapter-end 50

# 高并发批量下载
python core/cli.py batch-download BOOK_ID1 BOOK_ID2 BOOK_ID3 --concurrent 5

# 使用代理下载
python core/cli.py download 7372503659137005093 --proxy http://127.0.0.1:7890
```

## 🏗️ 项目结构

```
Fanqie-novel-Downloader/
├── core/                   # 核心功能模块
│   ├── novel_downloader.py # 小说下载核心逻辑
│   ├── cli.py             # 命令行界面
│   └── state_store.py     # 状态管理
├── web/                    # Web 界面
│   ├── web_app.py         # Flask Web 应用
│   ├── static/            # 静态资源（CSS/JS）
│   └── templates/         # HTML 模板
├── utils/                  # 工具模块
│   ├── node_manager.py    # 节点测试、状态缓存和故障恢复
│   ├── book_id.py         # 书籍ID处理
│   └── encoding_utils.py  # 编码处理
├── config/                 # 配置文件
│   ├── config.py          # 配置管理
│   ├── fanqie.json        # API 节点配置
│   └── requirements.txt   # Python 依赖
├── scripts/                # 脚本文件
│   └── termux_launcher.sh  # Termux 启动脚本
├── docs/                   # 文档
├── main.py                 # 主程序入口
└── tools/                  # 构建工具
    └── build_app.py       # 打包脚本
```

## 📸 界面预览

### Web 界面
- 🌐 现代化响应式设计
- 🔍 实时搜索功能
- 📊 下载进度显示
- 📱 移动端适配

### 命令行界面
- ⚡ 快速批量操作
- 🎛️ 丰富的参数选项
- 📈 进度条显示
- 🔧 高级配置支持

## 🛠️ 技术栈

### 后端技术
- **Python 3.7+**: 主要编程语言
- **Flask**: Web 框架，提供 RESTful API
- **aiohttp**: 异步 HTTP 客户端，提升下载速度
- **asyncio**: 异步编程，支持高并发
- **threading**: 多线程处理，提升性能

### 前端技术
- **HTML5/CSS3**: 现代化界面设计
- **JavaScript (ES6+)**: 交互逻辑
- **Bootstrap 5**: 响应式 UI 框架
- **jQuery**: DOM 操作和 AJAX

### 构建和部署
- **PyInstaller**: 跨平台可执行文件打包
- **GitHub Actions**: CI/CD 自动化构建
- **Docker**: 容器化部署支持

### 核心特性实现
- **节点管理**: 自动测试和优选最优 API 节点
- **故障恢复**: 节点故障自动切换
- **健康监控**: 实时监控节点状态
- **并发控制**: 令牌桶算法控制请求速率
- **状态缓存**: 节点状态持久化缓存

## 📊 下载统计

![GitHub Downloads](https://img.shields.io/github/downloads/POf-L/Fanqie-novel-Downloader/total?color=brightgreen)

### Star 历史

[![Star History Chart](https://api.star-history.com/svg?repos=POf-L/Fanqie-novel-Downloader&type=Date)](https://star-history.com/#POf-L/Fanqie-novel-Downloader&Date)

## 🔄 更新日志

### 最新版本特性
- ✨ 新增 GitHub Actions 云端下载功能
- 🐛 修复 Termux ARM64 兼容性问题
- 🚀 优化下载速度和稳定性
- 📱 改进移动端界面适配
- 🔧 新增节点自动优选和故障恢复
- 🌐 支持多种 API 节点源

### 性能优化
- ⚡ 异步并发下载，速度提升 3-5 倍
- 🎯 智能节点选择，降低延迟 40%
- 💾 状态缓存机制，减少重复测试
- 🔄 自动故障恢复，提高可用性

👉 [查看完整更新日志](CHANGELOG.md)

## 🤝 如何贡献

我们欢迎所有形式的贡献！

👉 [**查看贡献指南**](docs/CONTRIBUTING.md)

### 贡献方式
- 🐛 报告 Bug
- 💡 提出新功能建议
- 📝 改进文档
- 🔧 提交代码修复
- 🌟 推广项目

## ❓ 常见问题

### Q: 支持哪些平台？
A: 支持 Windows、macOS、Linux 和 Android (Termux)。提供可执行文件和源代码两种方式。

### Q: 下载的小说保存在哪里？
A: 
- **云端下载**: 在 GitHub Actions Artifacts 中，保留 30 天
- **本地下载**: 程序目录的 `novels/` 文件夹
- **自定义路径**: 可在配置文件中修改保存路径

### Q: 可以批量下载吗？
A: 可以！支持批量下载多本小说，可设置并发数量（1-5）。建议单次不超过 20 本以避免超时。

### Q: 下载速度慢怎么办？
A: 
1. 增加并发数（最大 5）
2. 选择 TXT 格式（比 EPUB 快）
3. 使用 CLI 模式（通常比 Web 快）
4. 检查网络连接或使用代理
5. 避免在网络高峰期下载

### Q: 支持付费内容吗？
A: 仅支持免费内容。付费章节无法通过此工具下载。

### Q: 如何获取书籍 ID？
A: 三种方法：
1. 从网页 URL 获取：`https://fanqienovel.com/page/7372503659137005093`
2. 使用搜索功能：`python core/cli.py search "书名"`
3. 从番茄小说 APP 分享链接中提取

👉 [查看更多 FAQ](docs/LOCAL_INSTALLATION.md#常见问题)

## 📄 许可证

本项目采用 [MIT 许可证](LICENSE)。

## ⭐ 支持项目

如果这个项目对你有帮助，请：

- 🌟 给个 Star 支持一下
- 🔄 Fork 并分享给朋友
- 📝 提交反馈和建议
- 💖 [请作者喝杯咖啡](https://github.com/sponsors/POf-L)

## 🔗 相关链接

- [📦 下载页面](https://github.com/POf-L/Fanqie-novel-Downloader/releases)
- [🐛 问题反馈](https://github.com/POf-L/Fanqie-novel-Downloader/issues)
- [💬 讨论区](https://github.com/POf-L/Fanqie-novel-Downloader/discussions)
- [📖 在线文档](https://pof-l.github.io/Fanqie-novel-Downloader/)

---

<div align="center">

**[⬆️ 回到顶部](#番茄小说下载器)**

Made with ❤️ by [POf-L](https://github.com/POf-L)

</div>
