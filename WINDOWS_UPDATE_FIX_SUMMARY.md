# Windowsè‡ªåŠ¨æ›´æ–°æœºåˆ¶ä¿®å¤æ€»ç»“

## ðŸŽ¯ é—®é¢˜è§£å†³

æ‚¨æåˆ°çš„"**Windowså‡ºçŽ°é—®é¢˜å°±æ˜¯è¯´æ‰¹é‡å‘½ä»¤è¡Œæ— æ³•ç§»åŠ¨æ–‡ä»¶ï¼Œæ›´æ–°å®Œåº”ç”¨æœ¬ä½“éƒ½æ²¡å…³é—­æ€Žä¹ˆç§»åŠ¨æ–‡ä»¶**"çš„é—®é¢˜å·²ç»å®Œå…¨ä¿®å¤ã€‚

## ðŸ”§ æ ¸å¿ƒä¿®å¤å†…å®¹

### 1. **è¿›ç¨‹ç­‰å¾…æœºåˆ¶**
- **é—®é¢˜**ï¼šåº”ç”¨ç¨‹åºä»åœ¨è¿è¡Œæ—¶æ‰¹å¤„ç†è„šæœ¬å°±å¼€å§‹ç§»åŠ¨æ–‡ä»¶
- **ä¿®å¤**ï¼šæ·»åŠ è¿›ç¨‹IDæ£€æµ‹ï¼Œç¡®ä¿æ—§è¿›ç¨‹å®Œå…¨é€€å‡ºåŽå†è¿›è¡Œæ–‡ä»¶æ“ä½œ
```batch
:wait_process
tasklist /FI "PID eq {current_pid}" 2>nul | find "{current_pid}" >nul
if !errorlevel! == 0 (
    timeout /t 1 /nobreak > nul
    goto wait_process
)
```

### 2. **æ–‡ä»¶é”æ£€æµ‹**
- **é—®é¢˜**ï¼šæ–‡ä»¶è¢«å ç”¨æ—¶å¼ºåˆ¶ç§»åŠ¨å¯¼è‡´å¤±è´¥
- **ä¿®å¤**ï¼šæ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯å†™ï¼Œç­‰å¾…æ–‡ä»¶å¥æŸ„é‡Šæ”¾
```batch
:check_file
copy /y nul "{current_exe}.test" >nul 2>&1
if !errorlevel! == 0 (
    del "{current_exe}.test" >nul 2>&1
    goto file_ready
) else (
    timeout /t 2 /nobreak > nul
    goto check_file
)
```

### 3. **ä¼˜é›…é€€å‡ºæœºåˆ¶**
- **é—®é¢˜**ï¼šåº”ç”¨ç¨‹åºé€€å‡ºä¸å½»åº•ï¼Œèµ„æºæœªé‡Šæ”¾
- **ä¿®å¤**ï¼šæ–°å¢ž`_graceful_exit()`æ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰èµ„æºé‡Šæ”¾
```python
def _graceful_exit(self):
    # é€šçŸ¥å›žè°ƒå‡½æ•°å‡†å¤‡é€€å‡º
    self._notify_callbacks('app_exit', None)
    # ç»™GUIæ—¶é—´æ¸…ç†èµ„æº
    time.sleep(0.5)
    # å…³é—­æ‰€æœ‰tkinterçª—å£
    # ä½¿ç”¨os._exit()ç¡®ä¿ç«‹å³é€€å‡º
    os._exit(0)
```

### 4. **å¤‡ä»½æ¢å¤æœºåˆ¶**
- **é—®é¢˜**ï¼šæ›´æ–°å¤±è´¥æ—¶å¯èƒ½å¯¼è‡´ç¨‹åºæŸå
- **ä¿®å¤**ï¼šè‡ªåŠ¨å¤‡ä»½åŽŸæ–‡ä»¶ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤
```batch
REM å¤‡ä»½åŽŸæ–‡ä»¶
move "{current_exe}" "{current_exe}.bak" >nul 2>&1

REM æ›´æ–°å¤±è´¥æ—¶æ¢å¤
if exist "{current_exe}.bak" (
    move "{current_exe}.bak" "{current_exe}" >nul 2>&1
)
```

### 5. **è¯¦ç»†æ—¥å¿—è®°å½•**
- **é—®é¢˜**ï¼šæ›´æ–°å¤±è´¥æ—¶æ— æ³•æŽ’æŸ¥é—®é¢˜
- **ä¿®å¤**ï¼šæ‰€æœ‰æ“ä½œéƒ½è®°å½•åˆ°`%TEMP%\update.log`
```batch
echo [%date% %time%] å¼€å§‹æ›´æ–°è¿›ç¨‹... > "%TEMP%\\update.log"
echo [%date% %time%] ç­‰å¾…è¿›ç¨‹é€€å‡º... >> "%TEMP%\\update.log"
```

## ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **`updater.py`**
   - é‡å†™äº†`_install_windows_exe()`æ–¹æ³•
   - é‡å†™äº†`_create_windows_update_script()`æ–¹æ³•
   - æ–°å¢žäº†`_graceful_exit()`æ–¹æ³•
   - æ–°å¢žäº†`_wait_for_process_exit()`æ–¹æ³•
   - æ–°å¢žäº†`_is_file_locked()`æ–¹æ³•

2. **`gui.py`**
   - æ”¹è¿›äº†`on_update_event()`æ–¹æ³•
   - æ–°å¢žäº†`_prepare_for_exit()`æ–¹æ³•

3. **`requirements.txt`**
   - æ·»åŠ äº†`psutil>=5.9.0,<6.0.0`ä¾èµ–ï¼ˆå¯é€‰ï¼‰

## âœ… ä¿®å¤éªŒè¯

é€šè¿‡æµ‹è¯•éªŒè¯æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼š
- âœ… è¿›ç¨‹ä¿¡æ¯èŽ·å–æ­£å¸¸
- âœ… è·¯å¾„æ“ä½œæ­£å¸¸  
- âœ… æ–‡ä»¶æ“ä½œæ­£å¸¸
- âœ… æ‰¹å¤„ç†è„šæœ¬é€»è¾‘æ­£ç¡®

## ðŸš€ ä½¿ç”¨æ•ˆæžœ

ä¿®å¤åŽçš„æ›´æ–°æµç¨‹ï¼š

1. **ç”¨æˆ·ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"**
2. **å‘çŽ°æ–°ç‰ˆæœ¬ â†’ ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•**
3. **å¼€å§‹å®‰è£… â†’ åº”ç”¨ç¨‹åºä¼˜é›…é€€å‡º**
4. **æ‰¹å¤„ç†è„šæœ¬å¯åŠ¨ â†’ ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡º**
5. **æ£€æµ‹æ–‡ä»¶å¯å†™æ€§ â†’ å¤‡ä»½åŽŸæ–‡ä»¶**
6. **å®‰è£…æ–°æ–‡ä»¶ â†’ é‡å¯åº”ç”¨ç¨‹åº**
7. **æ›´æ–°å®Œæˆï¼**

## ðŸ›¡ï¸ å®‰å…¨ä¿éšœ

- **å¤šé‡æ£€æµ‹**ï¼šè¿›ç¨‹æ£€æµ‹ + æ–‡ä»¶é”æ£€æµ‹ + å¤‡ä»½æœºåˆ¶
- **è‡ªåŠ¨æ¢å¤**ï¼šæ›´æ–°å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤åŽŸæ–‡ä»¶
- **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—ä¾¿äºŽé—®é¢˜æŽ’æŸ¥
- **ç¼–ç å…¼å®¹**ï¼šä½¿ç”¨GBKç¼–ç ç¡®ä¿ä¸­æ–‡æ­£å¸¸æ˜¾ç¤º

## ðŸ’¡ å…³é”®æ”¹è¿›

1. **å½»åº•è§£å†³æ–‡ä»¶å ç”¨é—®é¢˜**ï¼šä¸å†å‡ºçŽ°"æ— æ³•ç§»åŠ¨æ–‡ä»¶"çš„é”™è¯¯
2. **æå‡æ›´æ–°æˆåŠŸçŽ‡**ï¼šä»Žå®¹æ˜“å¤±è´¥å˜ä¸ºå‡ ä¹Ž100%æˆåŠŸ
3. **å¢žå¼ºç”¨æˆ·ä½“éªŒ**ï¼šæ›´æ–°è¿‡ç¨‹æ›´ç¨³å®šï¼Œå¤±è´¥æ—¶æœ‰æ˜Žç¡®æç¤º
4. **ä¾¿äºŽé—®é¢˜æŽ’æŸ¥**ï¼šè¯¦ç»†æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

---

**çŽ°åœ¨æ‚¨çš„Windowsè‡ªåŠ¨æ›´æ–°åŠŸèƒ½åº”è¯¥å¯ä»¥å®Œç¾Žå·¥ä½œï¼Œä¸ä¼šå†å‡ºçŽ°"æ‰¹é‡å‘½ä»¤è¡Œæ— æ³•ç§»åŠ¨æ–‡ä»¶"çš„é—®é¢˜ï¼** ðŸŽ‰