name: Download Novels

on:
  workflow_dispatch:
    inputs:
      book_ids:
        description: "ä¹¦ç± ID åˆ—è¡¨ï¼ˆç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼š7372503659137005093, 7372528691033300280ï¼‰"
        required: true
        type: string
      file_format:
        description: "è¾“å‡ºæ ¼å¼"
        required: true
        type: choice
        options:
          - txt
          - epub
        default: "txt"
      save_path:
        description: "ä¿å­˜è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰"
        required: false
        type: string
        default: "downloads"
      concurrent:
        description: "å¹¶å‘ä¸‹è½½æ•°é‡ï¼ˆ1-5ï¼‰"
        required: false
        type: number
        default: 3

permissions:
  contents: read

jobs:
  download:
    runs-on: ubuntu-latest
    name: ä¸‹è½½å°è¯´

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: config/requirements.txt

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libheif1 libheif-dev

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          
          # è‡ªåŠ¨ç”Ÿæˆä¾èµ–æ–‡ä»¶
          echo "ğŸ” æ­£åœ¨æ‰«æä»£ç ä¾èµ–..."
          python -m pip install pipreqs
          python -m pipreqs . --force --ignore .git --savepath config/requirements-auto.txt
          
          # éªŒè¯ç”Ÿæˆçš„ä¾èµ–æ–‡ä»¶
          if [ ! -f "config/requirements-auto.txt" ]; then
            echo "âŒ è‡ªåŠ¨ç”Ÿæˆä¾èµ–æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶"
            pip install --prefer-binary -r config/requirements.txt
          else
            echo "ğŸ“‹ è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–:"
            cat config/requirements-auto.txt
            echo ""
            
            # å¦‚æœå­˜åœ¨åŸå§‹ requirements.txtï¼Œåˆå¹¶ç‰ˆæœ¬ä¿¡æ¯
            if [ -f "config/requirements.txt" ]; then
              echo "ğŸ”„ åˆå¹¶ç‰ˆæœ¬ä¿¡æ¯..."
              python - <<'PY'
              import re
              
              # è¯»å–è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–
              with open('config/requirements-auto.txt', 'r') as f:
                  auto_deps = set(line.strip().split('>=')[0].split('==')[0] for line in f if line.strip() and not line.startswith('#'))
              
              # è¯»å–åŸå§‹ä¾èµ–åŠç‰ˆæœ¬
              version_map = {}
              try:
                  with open('config/requirements.txt', 'r') as f:
                      for line in f:
                          line = line.strip()
                          if line and not line.startswith('#'):
                              match = re.match(r'^([a-zA-Z0-9_-]+)', line)
                              if match:
                                  pkg_name = match.group(1)
                                  version_map[pkg_name] = line
              except FileNotFoundError:
                  pass
              
              # ç”Ÿæˆåˆå¹¶åçš„ä¾èµ–æ–‡ä»¶
              with open('config/requirements-final.txt', 'w') as f:
                  f.write("# è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ–‡ä»¶ - GitHub Actions\n")
                  f.write("# ç”Ÿæˆæ—¶é—´: $(date)\n\n")
                  
                  for dep in sorted(auto_deps):
                      if dep in version_map:
                          f.write(f"{version_map[dep]}\n")
                      else:
                          f.write(f"{dep}\n")
              
              print("âœ… åˆå¹¶å®Œæˆï¼Œä½¿ç”¨ config/requirements-final.txt")
              PY
              
              pip install --prefer-binary -r config/requirements-final.txt
            else
              pip install --prefer-binary -r config/requirements-auto.txt
            fi
          fi

      - name: è§£æä¹¦ç± ID åˆ—è¡¨
        id: parse_ids
        run: |
          IDS="${{ github.event.inputs.book_ids }}"
          IDS=$(echo "$IDS" | tr ',' ' ' | tr -s ' ')
          echo "Parsed book IDs: $IDS"
          echo "book_ids=$IDS" >> $GITHUB_OUTPUT

          COUNT=$(echo "$IDS" | wc -w)
          echo "Total books: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºä¸‹è½½ç›®å½•
        run: |
          mkdir -p "${{ github.event.inputs.save_path }}"
          echo "ä¸‹è½½ç›®å½•: ${{ github.event.inputs.save_path }}"

      - name: æ‰§è¡Œæ‰¹é‡ä¸‹è½½
        id: download
        run: |
          echo "å¼€å§‹ä¸‹è½½ ${{ steps.parse_ids.outputs.count }} æœ¬å°è¯´..."
          echo "æ ¼å¼: ${{ github.event.inputs.file_format }}"
          echo "å¹¶å‘æ•°: ${{ github.event.inputs.concurrent }}"
          echo "ä¿å­˜è·¯å¾„: ${{ github.event.inputs.save_path }}"
          echo ""

          python core/cli.py batch-download \
            ${{ steps.parse_ids.outputs.book_ids }} \
            --path "${{ github.event.inputs.save_path }}" \
            --format "${{ github.event.inputs.file_format }}" \
            --concurrent ${{ github.event.inputs.concurrent }}

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "[OK] ä¸‹è½½å®Œæˆ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "[!] ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ˆé€€å‡ºç : $EXIT_CODEï¼‰"
            echo "status=partial" >> $GITHUB_OUTPUT
          fi

      - name: ç»Ÿè®¡ä¸‹è½½ç»“æœ
        id: stats
        run: |
          SAVE_PATH="${{ github.event.inputs.save_path }}"

          if [ -d "$SAVE_PATH" ]; then
            FILE_COUNT=$(find "$SAVE_PATH" -type f -name "*.${{ github.event.inputs.file_format }}" | wc -l)
            TOTAL_SIZE=$(du -sh "$SAVE_PATH" | cut -f1)

            echo "[STATS] ä¸‹è½½ç»Ÿè®¡:"
            echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            echo "- æ€»å¤§å°: $TOTAL_SIZE"
            echo ""
            echo "[FILES] æ–‡ä»¶åˆ—è¡¨:"
            find "$SAVE_PATH" -type f -name "*.${{ github.event.inputs.file_format }}" -exec ls -lh {} \; | awk '{print "  - " $9 " (" $5 ")"}'

            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          else
            echo "[!] ä¸‹è½½ç›®å½•ä¸å­˜åœ¨"
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "total_size=0" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ä¸º Artifact
        if: steps.stats.outputs.file_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}
          path: ${{ github.event.inputs.save_path }}/**/*.${{ github.event.inputs.file_format }}
          retention-days: 30
          if-no-files-found: warn

      - name: ç”Ÿæˆä¸‹è½½æŠ¥å‘Š
        if: always()
        run: |
          echo "## [REPORT] å°è¯´ä¸‹è½½æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### [CONFIG] ä¸‹è½½é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| [BOOKS] ä¹¦ç±æ•°é‡ | ${{ steps.parse_ids.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [FORMAT] è¾“å‡ºæ ¼å¼ | \`${{ github.event.inputs.file_format }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| [CONCURRENT] å¹¶å‘æ•° | ${{ github.event.inputs.concurrent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [PATH] ä¿å­˜è·¯å¾„ | \`${{ github.event.inputs.save_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### [STATS] ä¸‹è½½ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| [OK] æˆåŠŸæ–‡ä»¶ | ${{ steps.stats.outputs.file_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [SIZE] æ€»å¤§å° | ${{ steps.stats.outputs.total_size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [ARTIFACT] Artifact | \`novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.stats.outputs.file_count }}" -gt "0" ]; then
            echo "### [DOWNLOAD] å¦‚ä½•ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. è¿›å…¥æœ¬æ¬¡è¿è¡Œçš„ **Summary** é¡µé¢" >> $GITHUB_STEP_SUMMARY
            echo "2. åœ¨é¡µé¢åº•éƒ¨æ‰¾åˆ° **Artifacts** åŒºåŸŸ" >> $GITHUB_STEP_SUMMARY
            echo "3. ç‚¹å‡» \`novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}\` ä¸‹è½½å‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
            echo "4. è§£å‹åå³å¯è·å¾—æ‰€æœ‰ä¸‹è½½çš„å°è¯´æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> [INFO] æç¤º: Artifact å°†ä¿ç•™ 30 å¤©" >> $GITHUB_STEP_SUMMARY
          else
            echo "### [!] ä¸‹è½½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥:" >> $GITHUB_STEP_SUMMARY
            echo "- ä¹¦ç± ID æ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "- API æœåŠ¡æ˜¯å¦å¯ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸‹è½½å®Œæˆé€šçŸ¥
        if: always()
        run: |
          if [ "${{ steps.stats.outputs.file_count }}" -gt "0" ]; then
            echo "[OK] ä¸‹è½½ä»»åŠ¡å®Œæˆï¼æˆåŠŸä¸‹è½½ ${{ steps.stats.outputs.file_count }} ä¸ªæ–‡ä»¶"
          else
            echo "[X] ä¸‹è½½ä»»åŠ¡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
            exit 1
          fi
