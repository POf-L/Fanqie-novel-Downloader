name: Download Novels

on:
  workflow_dispatch:
    inputs:
      book_ids:
        description: "书籍 ID 列表（逗号或空格分隔）"
        required: true
        type: string
      file_format:
        description: "输出格式"
        required: true
        type: choice
        options:
          - txt
          - epub
        default: "txt"
      save_path:
        description: "保存路径（相对于项目根目录）"
        required: false
        type: string
        default: "downloads"
      concurrent:
        description: "并发下载数量（1-5）"
        required: false
        type: number
        default: 3

permissions:
  contents: read

env:
  PYTHONUTF8: "1"
  PYTHONIOENCODING: utf-8

jobs:
  download:
    runs-on: ubuntu-latest
    name: Download Novels
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: config/requirements.txt

      - name: Install system dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y libheif1 libheif-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --prefer-binary -r config/requirements.txt

      - name: Parse book IDs
        id: parse_ids
        shell: python
        env:
          RAW_IDS: ${{ github.event.inputs.book_ids }}
        run: |
          import os, re
          raw = os.environ["RAW_IDS"]
          ids = re.split(r"[,\s]+", raw.strip())
          ids = [i for i in ids if i]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"book_ids={' '.join(ids)}\n")
              f.write(f"count={len(ids)}\n")
          print(f"Parsed {len(ids)} book IDs: {' '.join(ids)}")

      - name: Download novels
        id: download
        run: |
          mkdir -p "${{ github.event.inputs.save_path }}"

          python core/cli.py batch-download \
            ${{ steps.parse_ids.outputs.book_ids }} \
            --path "${{ github.event.inputs.save_path }}" \
            --format "${{ github.event.inputs.file_format }}" \
            --concurrent ${{ github.event.inputs.concurrent }} \
            && echo "status=success" >> "$GITHUB_OUTPUT" \
            || echo "status=partial" >> "$GITHUB_OUTPUT"

      - name: Collect stats
        id: stats
        run: |
          SAVE_PATH="${{ github.event.inputs.save_path }}"
          FORMAT="${{ github.event.inputs.file_format }}"

          if [ -d "$SAVE_PATH" ]; then
            FILE_COUNT=$(find "$SAVE_PATH" -type f -name "*.${FORMAT}" | wc -l)
            TOTAL_SIZE=$(du -sh "$SAVE_PATH" 2>/dev/null | cut -f1 || echo "0")
            echo "file_count=${FILE_COUNT}" >> "$GITHUB_OUTPUT"
            echo "total_size=${TOTAL_SIZE}" >> "$GITHUB_OUTPUT"
            echo "Downloaded ${FILE_COUNT} files, total size: ${TOTAL_SIZE}"
          else
            echo "file_count=0" >> "$GITHUB_OUTPUT"
            echo "total_size=0" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/upload-artifact@v4
        if: steps.stats.outputs.file_count > 0
        with:
          name: novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}
          path: ${{ github.event.inputs.save_path }}/**/*.${{ github.event.inputs.file_format }}
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'HEADER'
          ## 小说下载报告

          ### 下载配置
          | 项目 | 值 |
          | :--- | :--- |
          HEADER

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          | 书籍数量 | ${{ steps.parse_ids.outputs.count }} |
          | 输出格式 | \`${{ github.event.inputs.file_format }}\` |
          | 并发数 | ${{ github.event.inputs.concurrent }} |
          | 保存路径 | \`${{ github.event.inputs.save_path }}\` |

          ### 下载结果
          | 项目 | 值 |
          | :--- | :--- |
          | 成功文件 | ${{ steps.stats.outputs.file_count }} |
          | 总大小 | ${{ steps.stats.outputs.total_size }} |
          | Artifact | \`novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}\` |
          EOF

          FILE_COUNT="${{ steps.stats.outputs.file_count }}"
          if [ "$FILE_COUNT" -gt "0" ] 2>/dev/null; then
            cat >> "$GITHUB_STEP_SUMMARY" <<'GUIDE'

          ### 如何下载
          1. 进入本次运行的 **Summary** 页面
          2. 在页面底部找到 **Artifacts** 区域
          3. 点击对应 Artifact 下载压缩包
          4. 解压后即可获得所有下载的小说文件

          > Artifact 将保留 30 天
          GUIDE
          else
            cat >> "$GITHUB_STEP_SUMMARY" <<'FAIL'

          ### 下载失败
          没有成功下载任何文件，请检查:
          - 书籍 ID 是否正确
          - API 服务是否可用
          - 查看上方日志了解详细错误信息
          FAIL
            exit 1
          fi
