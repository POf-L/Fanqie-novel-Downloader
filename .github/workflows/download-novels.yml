name: Download Novels

on:
  workflow_dispatch:
    inputs:
      book_ids:
        description: 'ä¹¦ç±IDåè¡¨ï¼ç¨éå·æç©ºæ ¼åéï¼ä¾å¦ï¼7372503659137005093, 7372528691033300280ï¼'
        required: true
        type: string
      file_format:
        description: 'è¾åºæ ¼å¼'
        required: true
        type: choice
        options:
          - txt
          - epub
        default: 'txt'
      save_path:
        description: 'ä¿å­è·¯å¾ï¼ç¸å¯¹äºé¡¹ç®æ ¹ç®å½ï¼'
        required: false
        type: string
        default: 'downloads'
      concurrent:
        description: 'å¹¶åä¸è½½æ°éï¼1-5ï¼'
        required: false
        type: number
        default: 3

permissions:
  contents: read

jobs:
  download:
    runs-on: ubuntu-latest
    name: ä¸è½½å°è¯´

    steps:
      - name: æ£åºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Python ç¯å¢
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: config/requirements.txt

      - name: å®è£ç³»ç»ä¾èµ
        run: |
          sudo apt-get update
          sudo apt-get install -y libheif1 libheif-dev

      - name: å®è£ Python ä¾èµ
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r config/requirements.txt

      - name: è§£æä¹¦ç±IDåè¡¨
        id: parse_ids
        run: |
          # å°è¾å¥çä¹¦ç±IDè½¬æ¢ä¸ºæ°ç»
          IDS="${{ github.event.inputs.book_ids }}"
          # æ¿æ¢éå·åå¤ä¸ªç©ºæ ¼ä¸ºåä¸ªç©ºæ ¼
          IDS=$(echo "$IDS" | tr ',' ' ' | tr -s ' ')
          echo "Parsed book IDs: $IDS"
          echo "book_ids=$IDS" >> $GITHUB_OUTPUT

          # è®¡ç®ä¹¦ç±æ°é
          COUNT=$(echo "$IDS" | wc -w)
          echo "Total books: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: åå»ºä¸è½½ç®å½
        run: |
          mkdir -p "${{ github.event.inputs.save_path }}"
          echo "ä¸è½½ç®å½: ${{ github.event.inputs.save_path }}"

      - name: æ§è¡æ¹éä¸è½½
        id: download
        run: |
          echo "å¼å§ä¸è½½ ${{ steps.parse_ids.outputs.count }} æ¬å°è¯´..."
          echo "æ ¼å¼: ${{ github.event.inputs.file_format }}"
          echo "å¹¶åæ°: ${{ github.event.inputs.concurrent }}"
          echo "ä¿å­è·¯å¾: ${{ github.event.inputs.save_path }}"
          echo ""

          # ä½¿ç¨ CLI æ¹éä¸è½½
          python core/cli.py batch-download \
            ${{ steps.parse_ids.outputs.book_ids }} \
            --path "${{ github.event.inputs.save_path }}" \
            --format "${{ github.event.inputs.file_format }}" \
            --concurrent ${{ github.event.inputs.concurrent }}

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "[OK] ä¸è½½å®æ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "[!] ä¸è½½è¿ç¨ä¸­åºç°éè¯¯ï¼éåºç : $EXIT_CODEï¼"
            echo "status=partial" >> $GITHUB_OUTPUT
          fi

      - name: ç»è®¡ä¸è½½ç»æ
        id: stats
        run: |
          SAVE_PATH="${{ github.event.inputs.save_path }}"

          if [ -d "$SAVE_PATH" ]; then
            FILE_COUNT=$(find "$SAVE_PATH" -type f -name "*.${{ github.event.inputs.file_format }}" | wc -l)
            TOTAL_SIZE=$(du -sh "$SAVE_PATH" | cut -f1)

            echo "[STATS] ä¸è½½ç»è®¡:"
            echo "- æä»¶æ°é: $FILE_COUNT"
            echo "- æ»å¤§å°: $TOTAL_SIZE"
            echo ""
            echo "[FILES] æä»¶åè¡¨:"
            find "$SAVE_PATH" -type f -name "*.${{ github.event.inputs.file_format }}" -exec ls -lh {} \; | awk '{print "  - " $9 " (" $5 ")"}'

            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          else
            echo "[!] ä¸è½½ç®å½ä¸å­å¨"
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "total_size=0" >> $GITHUB_OUTPUT
          fi

      - name: ä¸ä¼ ä¸è½½æä»¶ä¸º Artifact
        if: steps.stats.outputs.file_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}
          path: ${{ github.event.inputs.save_path }}/**/*.${{ github.event.inputs.file_format }}
          retention-days: 30
          if-no-files-found: warn

      - name: çæä¸è½½æ¥å
        if: always()
        run: |
          echo "## [REPORT] å°è¯´ä¸è½½æ¥å" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### [CONFIG] ä¸è½½éç½®" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç® | å¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| [BOOKS] ä¹¦ç±æ°é | ${{ steps.parse_ids.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [FORMAT] è¾åºæ ¼å¼ | \`${{ github.event.inputs.file_format }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| [CONCURRENT] å¹¶åæ° | ${{ github.event.inputs.concurrent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [PATH] ä¿å­è·¯å¾ | \`${{ github.event.inputs.save_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### [STATS] ä¸è½½ç»æ" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç® | å¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| [OK] æåæä»¶ | ${{ steps.stats.outputs.file_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [SIZE] æ»å¤§å° | ${{ steps.stats.outputs.total_size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| [ARTIFACT] Artifact | \`novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.stats.outputs.file_count }}" -gt "0" ]; then
            echo "### [DOWNLOAD] å¦ä½ä¸è½½" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. è¿å¥æ¬æ¬¡è¿è¡ç **Summary** é¡µé¢" >> $GITHUB_STEP_SUMMARY
            echo "2. å¨é¡µé¢åºé¨æ¾å° **Artifacts** åºå" >> $GITHUB_STEP_SUMMARY
            echo "3. ç¹å» \`novels-${{ github.event.inputs.file_format }}-${{ github.run_number }}\` ä¸è½½åç¼©å" >> $GITHUB_STEP_SUMMARY
            echo "4. è§£ååå³å¯è·å¾ææä¸è½½çå°è¯´æä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> [INFO] æç¤º: Artifact å°ä¿ç 30 å¤©" >> $GITHUB_STEP_SUMMARY
          else
            echo "### [!] ä¸è½½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ²¡ææåä¸è½½ä»»ä½æä»¶ï¼è¯·æ£æ¥:" >> $GITHUB_STEP_SUMMARY
            echo "- ä¹¦ç±IDæ¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "- APIæå¡æ¯å¦å¯ç¨" >> $GITHUB_STEP_SUMMARY
            echo "- æ¥çä¸æ¹æ¥å¿äºè§£è¯¦ç»éè¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸è½½å®æéç¥
        if: always()
        run: |
          if [ "${{ steps.stats.outputs.file_count }}" -gt "0" ]; then
            echo "[OK] ä¸è½½ä»»å¡å®æï¼æåä¸è½½ ${{ steps.stats.outputs.file_count }} ä¸ªæä»¶"
          else
            echo "[X] ä¸è½½ä»»å¡å¤±è´¥ï¼è¯·æ¥çæ¥å¿"
            exit 1
          fi
