name: Close Stale Issues

on:
  schedule:
    # 每天中国时间12:00运行 (UTC+8，所以是UTC 04:00)
    - cron: '0 4 * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  issues: write

jobs:
  close-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Process stale issues
        uses: actions/github-script@v7
        with:
          script: |
            // ================= 配置区域 =================
            const DAYS_BEFORE_STALE = 1;  // 1天无回复则标记
            const DAYS_BEFORE_CLOSE = 2;  // 标记后2天无回复则关闭
            
            // 使用你的实际标签 "即将关闭" 作为警告标签
            const STALE_LABEL = '即将关闭'; 
            
            // 以下标签的 Issue 永远不会被自动关闭
            const EXEMPT_LABELS = [
              'pinned',           // 固定置顶
              '增强功能',         // Enhancement
              '错误反馈',         // Bug
              '求助',             // Help wanted
              '文献资料',         // Documentation
              '快速上手的issue'   // Good first issue
            ];
            // ===========================================

            const now = new Date();
            const staleDate = new Date(now - DAYS_BEFORE_STALE * 24 * 60 * 60 * 1000);
            
            // 获取所有 open 的 issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const issue of issues) {
              // 1. 跳过 PR (size:L 等标签通常用于PR，这里直接在逻辑层跳过所有PR)
              if (issue.pull_request) continue;

              // 2. 跳过有豁免标签的 issue
              const issueLabels = issue.labels.map(l => l.name);
              if (EXEMPT_LABELS.some(label => issueLabels.includes(label))) continue;

              // 3. 跳过有 assignee (负责人) 的 issue
              if (issue.assignees && issue.assignees.length > 0) continue;

              // 获取最后一条非 bot 的评论
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100
              });

              // 过滤掉机器人评论
              const humanComments = comments.data.filter(c =>
                !c.user.login.includes('[bot]') && c.user.type !== 'Bot'
              );

              // 计算最后活动时间
              const lastActivity = humanComments.length > 0
                ? new Date(humanComments[humanComments.length - 1].created_at)
                : new Date(issue.created_at);

              const hasStaleLabel = issueLabels.includes(STALE_LABEL);

              if (hasStaleLabel) {
                // === 已有 "即将关闭" 标签，检查是否需要关闭 ===
                
                // 找到何时被打上标签的
                const events = await github.rest.issues.listEvents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  per_page: 100
                });

                const staleLabelEvent = events.data
                  .filter(e => e.event === 'labeled' && e.label?.name === STALE_LABEL)
                  .pop();

                if (staleLabelEvent) {
                  const staleLabelDate = new Date(staleLabelEvent.created_at);

                  // 检查打标签后有没有新的人类回复
                  const newHumanComments = humanComments.filter(c =>
                    new Date(c.created_at) > staleLabelDate
                  );

                  if (newHumanComments.length > 0) {
                    // 有新回复 -> 移除 "即将关闭" 标签，复活 Issue
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      name: STALE_LABEL
                    });
                    console.log(`Removed label from #${issue.number} due to new activity`);
                  } else if (now - staleLabelDate >= DAYS_BEFORE_CLOSE * 24 * 60 * 60 * 1000) {
                    // 超时 -> 关闭 Issue
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: `此 issue 因超过 ${DAYS_BEFORE_STALE + DAYS_BEFORE_CLOSE} 天无回应已被自动关闭。\n如有需要，欢迎重新打开或提交新的 issue。\n\nThis issue has been automatically closed due to inactivity.`
                    });
                    
                    // 关闭并将原因标记为 "not_planned" (类似 won't fix)
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      state: 'closed',
                      state_reason: 'not_planned'
                    });
                    
                    // 可选：如果希望关闭时添加 "补丁" (wontfix) 标签，可在此处添加代码，但暂不建议，因为容易混淆
                    console.log(`Closed stale issue #${issue.number}`);
                  }
                }
              } else if (lastActivity < staleDate) {
                // === 没有标签且已过期 -> 添加 "即将关闭" 标签 ===
                
                const closeDateTime = new Date(now.getTime() + DAYS_BEFORE_CLOSE * 24 * 60 * 60 * 1000);
                const closeDateStr = closeDateTime.toLocaleDateString('zh-CN', {
                  year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Shanghai'
                });

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: [STALE_LABEL]
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `⚠️ **提醒**：此 issue 已超过 ${DAYS_BEFORE_STALE} 天没有新的回应。\n\n如果问题仍然存在，请回复此 issue，bot 将会自动移除标签。\n否则，它将于 **${closeDateStr}** 被自动标记为无效并关闭。`
                });
                console.log(`Marked issue #${issue.number} as stale`);
              }
            }
