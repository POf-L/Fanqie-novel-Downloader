name: Build and Release

on:
  workflow_dispatch:
    inputs:
      build_launcher:
        description: "是否重新构建 Launcher（通常为 false）"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  PYTHONUTF8: "1"
  PYTHONIOENCODING: utf-8

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_time: ${{ steps.version.outputs.BUILD_TIME }}
      tag_name: ${{ steps.version.outputs.TAG_NAME }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          VERSION="$(date -u +'%Y.%m.%d.%H%M')+$(echo '${{ github.sha }}' | cut -c1-7)"
          BUILD_TIME="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          TAG_NAME="v${VERSION}"
          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "BUILD_TIME=${BUILD_TIME}" >> "$GITHUB_OUTPUT"
          echo "TAG_NAME=${TAG_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}"
          body: |
            ## TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}

            ### 发布模式
            - 稳定 Launcher + 云端 Runtime
            - Runtime 包含代码与依赖

            ### 发布信息
            | 项目 | 详情 |
            | :--- | :--- |
            | 发布时间 | ${{ steps.version.outputs.BUILD_TIME }} |
            | Commit | `${{ github.sha }}` |

            ### 下载入口
            - 稳定启动器（长期固定）：https://github.com/${{ github.repository }}/releases/tag/launcher-stable
            - 本次 Runtime 资产：在本条 Release 的 Assets 中下载
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-launcher:
    needs: [prepare-release]
    if: inputs.build_launcher == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            launcher_name: FanqieLauncher-windows-x64.exe
            sep: ";"
            icon_arg: "--icon=assets/icons/icon.ico"
          - os: ubuntu-latest
            platform: linux-x64
            launcher_name: FanqieLauncher-linux-x64
            sep: ":"
            icon_arg: ""
          - os: macos-latest
            platform: macos-x64
            launcher_name: FanqieLauncher-macos-x64
            sep: ":"
            icon_arg: ""
    runs-on: ${{ matrix.os }}
    name: Build Launcher (${{ matrix.platform }})
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: config/requirements.txt

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller requests rich InquirerPy

      - name: Patch launcher repo config
        shell: python
        env:
          TARGET_REPO: ${{ github.repository }}
        run: |
          import os, re, sys
          target = os.environ["TARGET_REPO"]
          path = "launcher.py"
          with open(path, "r", encoding="utf-8") as f:
              content = f.read()
          content = re.sub(r"POf-L/Fanqie-novel-Downloader", target, content)
          with open(path, "w", encoding="utf-8") as f:
              f.write(content)
          print(f"Patched launcher repo -> {target}")

      - name: Build launcher executable
        shell: bash
        run: |
          python -m PyInstaller --onefile \
            --name="${{ matrix.launcher_name }}" \
            --console \
            --add-data "assets${{ matrix.sep }}assets" \
            --hidden-import=requests \
            --hidden-import=rich \
            --hidden-import=InquirerPy \
            --collect-all=rich \
            --collect-all=InquirerPy \
            ${{ matrix.icon_arg }} \
            launcher.py

      - uses: actions/upload-artifact@v4
        with:
          name: launcher-${{ matrix.platform }}
          path: dist/${{ matrix.launcher_name }}
          if-no-files-found: error

      - name: Upload launcher to versioned release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: dist/${{ matrix.launcher_name }}
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload launcher to stable channel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: launcher-stable
          name: FanqieLauncher Stable
          body: |
            ## FanqieLauncher Stable

            ### 快速开始
            1. 下载对应平台的 Launcher（无需安装 Python）
            2. 运行 Launcher，自动下载最新 Runtime
            3. 享受完整的小说下载功能

            ### 下载说明
            - **Windows**: `FanqieLauncher-windows-x64.exe`
            - **Linux**: `FanqieLauncher-linux-x64`
            - **macOS**: `FanqieLauncher-macos-x64`
          draft: false
          prerelease: false
          make_latest: true
          files: dist/${{ matrix.launcher_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-runtime:
    needs: [prepare-release]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            runtime_name: runtime-windows-x64.zip
          - os: ubuntu-latest
            platform: linux-x64
            runtime_name: runtime-linux-x64.zip
          - os: macos-latest
            platform: macos-x64
            runtime_name: runtime-macos-x64.zip
    runs-on: ${{ matrix.os }}
    name: Build Runtime (${{ matrix.platform }})
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: config/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --prefer-binary -r config/requirements.txt

      - name: Generate version.py
        shell: python
        env:
          VERSION: ${{ needs.prepare-release.outputs.version }}
          BUILD_TIME: ${{ needs.prepare-release.outputs.build_time }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          import os
          content = f'''# -*- coding: utf-8 -*-
          """版本信息文件 - GitHub Actions 自动生成"""

          __version__ = "{os.environ['VERSION']}"
          __author__ = "Tomato Novel Downloader"
          __description__ = "A modern novel downloader with GitHub auto-update support"
          __github_repo__ = "{os.environ['GITHUB_REPO']}"
          __build_time__ = "{os.environ['BUILD_TIME']}"
          __build_channel__ = "launcher-runtime"
          '''
          import textwrap
          with open("version.py", "w", encoding="utf-8") as f:
              f.write(textwrap.dedent(content))
          print("Generated version.py")

      - name: Build runtime package
        shell: python
        env:
          RUNTIME_NAME: ${{ matrix.runtime_name }}
          RUNNER_OS: ${{ runner.os }}
        run: |
          import os, shutil, subprocess, sys, zipfile
          from pathlib import Path

          dirs_to_copy = ["assets", "config", "core", "utils", "web"]
          files_to_copy = ["main.py"]
          if Path("version.py").exists():
              files_to_copy.append("version.py")

          for d in dirs_to_copy:
              if not Path(d).is_dir():
                  print(f"ERROR: required directory '{d}' not found")
                  sys.exit(1)
          for f in files_to_copy:
              if not Path(f).is_file():
                  print(f"ERROR: required file '{f}' not found")
                  sys.exit(1)

          runtime = Path("runtime")
          if runtime.exists():
              shutil.rmtree(runtime)
          runtime.mkdir()

          for d in dirs_to_copy:
              shutil.copytree(d, runtime / d)
          for f in files_to_copy:
              shutil.copy2(f, runtime / f)

          subprocess.check_call([sys.executable, "-m", "venv", str(runtime / ".venv")])

          if os.environ["RUNNER_OS"] == "Windows":
              venv_python = str(runtime / ".venv" / "Scripts" / "python")
          else:
              venv_python = str(runtime / ".venv" / "bin" / "python")

          subprocess.check_call([venv_python, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([
              venv_python, "-m", "pip", "install",
              "--prefer-binary", "-r", "config/requirements.txt"
          ])

          archive_name = os.environ["RUNTIME_NAME"]
          with zipfile.ZipFile(archive_name, "w", zipfile.ZIP_DEFLATED) as zf:
              for root, _, files in os.walk(runtime):
                  for file in files:
                      full = Path(root) / file
                      rel = full.relative_to(runtime)
                      zf.write(full, rel)
          print(f"Built runtime archive: {archive_name}")

      - name: Generate runtime manifest
        shell: python
        env:
          RUNTIME_NAME: ${{ matrix.runtime_name }}
          PLATFORM: ${{ matrix.platform }}
          TAG_NAME: ${{ needs.prepare-release.outputs.tag_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          import hashlib, json, os
          from datetime import datetime, timezone
          from pathlib import Path

          runtime_path = Path(os.environ["RUNTIME_NAME"])
          hasher = hashlib.sha256()
          with runtime_path.open("rb") as f:
              while chunk := f.read(1 << 20):
                  hasher.update(chunk)

          manifest = {
              "manifest_version": "1",
              "platform": os.environ["PLATFORM"],
              "runtime_version": os.environ["TAG_NAME"],
              "runtime_archive_name": runtime_path.name,
              "runtime_archive_url": (
                  f"https://github.com/{os.environ['REPO_NAME']}"
                  f"/releases/download/{os.environ['TAG_NAME']}/{runtime_path.name}"
              ),
              "runtime_archive_sha256": hasher.hexdigest(),
              "runtime_archive_size": runtime_path.stat().st_size,
              "min_launcher_version": "1.0.0",
              "generated_at": datetime.now(timezone.utc).isoformat(),
          }

          output = f"runtime-manifest-{os.environ['PLATFORM']}.json"
          with open(output, "w", encoding="utf-8") as f:
              json.dump(manifest, f, ensure_ascii=False, indent=2)
          print(f"Generated manifest: {output}")

      - uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ matrix.platform }}
          path: |
            ${{ matrix.runtime_name }}
            runtime-manifest-${{ matrix.platform }}.json
          if-no-files-found: error

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: |
            ${{ matrix.runtime_name }}
            runtime-manifest-${{ matrix.platform }}.json
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-runtime-termux:
    needs: [prepare-release]
    runs-on: ubuntu-latest
    name: Build Runtime (termux-arm64)
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Generate version.py
        shell: python
        env:
          VERSION: ${{ needs.prepare-release.outputs.version }}
          BUILD_TIME: ${{ needs.prepare-release.outputs.build_time }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          import os, textwrap
          content = f'''# -*- coding: utf-8 -*-
          """版本信息文件 - GitHub Actions 自动生成"""

          __version__ = "{os.environ['VERSION']}"
          __author__ = "Tomato Novel Downloader"
          __description__ = "A modern novel downloader with GitHub auto-update support"
          __github_repo__ = "{os.environ['GITHUB_REPO']}"
          __build_time__ = "{os.environ['BUILD_TIME']}"
          __build_channel__ = "launcher-runtime-termux"
          '''
          with open("version.py", "w", encoding="utf-8") as f:
              f.write(textwrap.dedent(content))
          print("Generated version.py")

      - name: Build termux runtime
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          install: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -q
            apt-get install -y python3 python3-pip python3-venv python3-dev \
              build-essential libffi-dev libssl-dev libjpeg-dev zlib1g-dev \
              libxml2-dev libxslt-dev zip
          run: |
            cd /workspace
            rm -rf runtime-termux
            mkdir -p runtime-termux

            for d in assets config core utils web; do
              cp -r "$d" runtime-termux/
            done
            cp main.py runtime-termux/
            [ -f version.py ] && cp version.py runtime-termux/

            python3 -m venv runtime-termux/.venv
            runtime-termux/.venv/bin/python -m pip install --upgrade pip
            runtime-termux/.venv/bin/python -m pip install \
              --default-timeout=3600 --prefer-binary \
              -r config/requirements-termux.txt

            cd runtime-termux
            zip -r ../runtime-termux-arm64.zip .

      - name: Generate termux manifest
        shell: python
        env:
          TAG_NAME: ${{ needs.prepare-release.outputs.tag_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          import hashlib, json, os
          from datetime import datetime, timezone
          from pathlib import Path

          runtime_path = Path("runtime-termux-arm64.zip")
          hasher = hashlib.sha256()
          with runtime_path.open("rb") as f:
              while chunk := f.read(1 << 20):
                  hasher.update(chunk)

          manifest = {
              "manifest_version": "1",
              "platform": "termux-arm64",
              "runtime_version": os.environ["TAG_NAME"],
              "runtime_archive_name": runtime_path.name,
              "runtime_archive_url": (
                  f"https://github.com/{os.environ['REPO_NAME']}"
                  f"/releases/download/{os.environ['TAG_NAME']}/{runtime_path.name}"
              ),
              "runtime_archive_sha256": hasher.hexdigest(),
              "runtime_archive_size": runtime_path.stat().st_size,
              "min_launcher_version": "1.0.0",
              "generated_at": datetime.now(timezone.utc).isoformat(),
          }

          with open("runtime-manifest-termux-arm64.json", "w", encoding="utf-8") as f:
              json.dump(manifest, f, ensure_ascii=False, indent=2)
          print("Generated termux manifest")

      - name: Prepare termux launcher
        run: |
          if [ -f "scripts/termux_launcher.sh" ]; then
            cp scripts/termux_launcher.sh TomatoNovelDownloader-termux-arm64
          else
            printf '#!/bin/bash\necho "Please manually activate the virtual environment"\n' \
              > TomatoNovelDownloader-termux-arm64
          fi
          chmod +x TomatoNovelDownloader-termux-arm64

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: |
            TomatoNovelDownloader-termux-arm64
            runtime-termux-arm64.zip
            runtime-manifest-termux-arm64.json
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize-release:
    name: Finalize Release
    if: always() && needs.prepare-release.result == 'success'
    needs: [prepare-release, build-runtime, build-runtime-termux, build-launcher]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          LATEST_TAG=$(curl -fsSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | python3 -c "import sys,json; print(json.load(sys.stdin).get('tag_name',''))" \
            2>/dev/null || true)

          if [ -n "$LATEST_TAG" ]; then
            RANGE="${LATEST_TAG}..${{ github.sha }}"
          else
            RANGE="HEAD~50..HEAD"
          fi

          CHANGELOG=$(git log "$RANGE" --pretty=format:'- `%h` %s' 2>/dev/null || echo "- No commit log available")

          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          {
            echo "content<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update release notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: TomatoNovelDownloader Runtime ${{ needs.prepare-release.outputs.tag_name }}
          body: |
            ## Runtime 更新包

            **注意：这是 Runtime 更新包，请通过 Launcher 自动下载使用。**

            ### 首次使用
            1. 首次使用请下载 [Launcher Stable](https://github.com/${{ github.repository }}/releases/tag/launcher-stable)
            2. 运行 Launcher，自动下载此 Runtime
            3. 无需手动下载 Runtime 文件

            ### 更新内容（距上一个版本）
            ${{ steps.changelog.outputs.content }}

            ---

            ### 构建信息
            | 项目 | 详情 |
            | :--- | :--- |
            | 构建时间 | ${{ needs.prepare-release.outputs.build_time }} |
            | 前次发布 | `${{ steps.changelog.outputs.latest_tag }}` |
            | Commit | `${{ github.sha }}` |
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
