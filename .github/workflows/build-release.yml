name: Build and Release

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ç”Ÿæˆç‰ˆæœ¬å·å¹¶åˆ›å»º Release
  prepare-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_time: ${{ steps.version.outputs.BUILD_TIME }}
      tag_name: ${{ steps.version.outputs.TAG_NAME }}
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Debug trigger info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "SHA: ${{ github.sha }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="v$VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
          echo "Tag name: $TAG_NAME"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}"
          body: |
            ## ğŸš€ TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}

            ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            | :--- | :--- |
            | ğŸ•’ **å‘å¸ƒæ—¶é—´** | ${{ steps.version.outputs.BUILD_TIME }} |
            | ğŸŒ¿ **åˆ†æ”¯/Tag** | `${{ github.ref_name }}` |
            | ğŸ”— **Commit** | `${{ github.sha }}` |

            ---

            ### ğŸ“ æ›´æ–°å†…å®¹
            æ­£åœ¨æ•´ç†è‡ªä¸Šä¸€ä¸ª Latest ç‰ˆæœ¬ä»¥æ¥çš„æäº¤è®°å½•...
          draft: false
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: [prepare-release]
    if: needs.prepare-release.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows å‘å¸ƒç‰ˆ
          - os: windows-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: .exe
            release_name: TomatoNovelDownloader.exe
            artifact_name: TomatoNovelDownloader-windows-x64
            build_flags: '--windowed'
          # Windows è°ƒè¯•ç‰ˆ
          - os: windows-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: .exe
            release_name: TomatoNovelDownloader-debug.exe
            artifact_name: TomatoNovelDownloader-debug-windows-x64
            build_flags: '--console'
          # Windows Standalone (å†…ç½® WebView2)
          - os: windows-latest
            variant: release-standalone
            executable: TomatoNovelDownloader-Standalone
            ext: .exe
            release_name: TomatoNovelDownloader-Standalone.exe
            artifact_name: TomatoNovelDownloader-standalone-windows-x64
            build_flags: '--windowed --add-data "WebView2;WebView2"'
          # Linux å‘å¸ƒç‰ˆ
          - os: ubuntu-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: ''
            release_name: TomatoNovelDownloader-linux
            artifact_name: TomatoNovelDownloader-linux-x64
            build_flags: '--windowed'
          # Linux è°ƒè¯•ç‰ˆ
          - os: ubuntu-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: ''
            release_name: TomatoNovelDownloader-debug-linux
            artifact_name: TomatoNovelDownloader-debug-linux-x64
            build_flags: '--console'
          # macOS å‘å¸ƒç‰ˆ
          - os: macos-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: ''
            release_name: TomatoNovelDownloader-macos
            artifact_name: TomatoNovelDownloader-macos-x64
            build_flags: '--windowed'
          # macOS è°ƒè¯•ç‰ˆ
          - os: macos-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: ''
            release_name: TomatoNovelDownloader-debug-macos
            artifact_name: TomatoNovelDownloader-debug-macos-x64
            build_flags: '--console'

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - ${{ matrix.variant }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: config/requirements.txt

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libheif1 libheif-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libheif || true

      - name: Update version.py
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          BUILD_TIME="${{ needs.prepare-release.outputs.build_time }}"
          echo "Using version: $VERSION"
          echo "Using build time: $BUILD_TIME"
          
          # å®Œå…¨é‡å†™version.pyæ–‡ä»¶ï¼Œç¡®ä¿__build_channel__æ­£ç¡®è®¾ç½®
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"POf-L/Fanqie-novel-Downloader\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"github-actions\"" >> version.py
          
          echo "âœ… æ›´æ–°åçš„version.py:"
          cat version.py
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --prefer-binary -r config/requirements.txt
          python -m pip install --prefer-binary pyinstaller
        shell: bash

      - name: Download WebView2 Runtime (Standalone only)
        if: matrix.variant == 'release-standalone'
        run: |
          # ä¸‹è½½ WebView2 Fixed Version Runtime (é€šè¿‡ NuGet åŒ…è·å–)
          curl -L -o webview2.zip "https://www.nuget.org/api/v2/package/WebView2.Runtime.X64/129.0.2792.52"
          7z x webview2.zip -oWebView2Temp
          
          # æŸ¥æ‰¾åŒ…å« msedgewebview2.exe çš„æ–‡ä»¶å¤¹
          TARGET_DIR=$(find WebView2Temp -name "msedgewebview2.exe" | head -n 1 | xargs dirname)
          
          if [ -z "$TARGET_DIR" ]; then
            echo "Error: Could not find msedgewebview2.exe in package"
            # å°è¯•åˆ—å‡ºæ–‡ä»¶ä»¥ä¾›è°ƒè¯•
            find WebView2Temp
            exit 1
          fi
          
          echo "Found runtime at $TARGET_DIR"
          # ç§»åŠ¨åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ WebView2 æ–‡ä»¶å¤¹
          mv "$TARGET_DIR" ./WebView2
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf WebView2Temp webview2.zip
          
          echo "[OK] WebView2 Runtime prepared"
        shell: bash

      - name: Generate high-quality Windows icon
        if: runner.os == 'Windows'
        run: |
          # å®‰è£… Pillow ç”¨äºå¤„ç†å›¾æ ‡
          pip install Pillow
          
          # ä½¿ç”¨ä¿®å¤åçš„å›¾æ ‡ç”Ÿæˆé«˜è´¨é‡çš„å¤šå°ºå¯¸ .ico æ–‡ä»¶
          python -c "
          from PIL import Image
          import os
          
          # åŠ è½½ä¿®å¤åçš„é«˜åˆ†è¾¨ç‡åŸå›¾ï¼ˆå·²å¡«å……å®Œæ•´ï¼‰
          img = Image.open('assets/icons/icon_256.png')
          
          # ç¡®ä¿å›¾æ ‡æ˜¯æ­£æ–¹å½¢ä¸”å®Œå…¨å¡«å……
          if img.size != (256, 256):
              img = img.resize((256, 256), Image.Resampling.LANCZOS)
          
          # åˆ›å»ºå¤šå°ºå¯¸å›¾æ ‡åˆ—è¡¨
          sizes = [(16, 16), (32, 32), (48, 48), (64, 64), (128, 128), (256, 256)]
          icons = []
          
          for size in sizes:
              # è°ƒæ•´å¤§å°ï¼Œä¿æŒé«˜è´¨é‡
              resized = img.resize(size, Image.Resampling.LANCZOS)
              icons.append(resized)
          
          # ä¿å­˜ä¸º .ico æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å°ºå¯¸
          icons[0].save('assets/icons/icon_high_quality.ico',
                       format='ICO',
                       sizes=[(img.width, img.height) for img in icons],
                       append_images=icons[1:])
          
          print('[OK] High-quality icon generation completed (filled)')
          "
        env:
          PYTHONIOENCODING: utf-8

      - name: Build application (${{ matrix.variant }})
        run: |
          # Determine separator for add-data based on OS
          if [ "${{ runner.os }}" == "Windows" ]; then
            SEP=";"
            # ä½¿ç”¨ç”Ÿæˆçš„é«˜è´¨é‡ .ico æ–‡ä»¶
            ICON_FLAG="--icon=assets/icons/icon_high_quality.ico"
          else
            SEP=":"
            # Linux/macOS ä½¿ç”¨é«˜åˆ†è¾¨ç‡ PNG
            ICON_FLAG="--icon=assets/icons/icon_256.png"
          fi

          python -m PyInstaller --onefile \
            --name=${{ matrix.executable }} \
            ${{ matrix.build_flags }} \
            $ICON_FLAG \
            --add-data "web/static${SEP}static" \
            --add-data "web/templates${SEP}templates" \
            --add-data "config/fanqie.json${SEP}." \
            --hidden-import=flask \
            --hidden-import=flask_cors \
            --hidden-import=webview \
            --hidden-import=PIL \
            --hidden-import=requests \
            --hidden-import=aiohttp \
            --hidden-import=asyncio \
            --hidden-import=concurrent.futures \
            --hidden-import=threading \
            --hidden-import=bs4 \
            --hidden-import=ebooklib \
            --hidden-import=fake_useragent \
            --hidden-import=config \
            --hidden-import=config.config \
            --hidden-import=version \
            --hidden-import=web \
            --hidden-import=web.web_app \
            --hidden-import=utils \
            --hidden-import=utils.updater \
            --hidden-import=utils.encoding_utils \
            --hidden-import=utils.platform_utils \
            --hidden-import=utils.packaging_fixes \
            --hidden-import=utils.watermark \
            --hidden-import=utils.async_logger \
            --hidden-import=utils.messages \
            --hidden-import=utils.node_manager \
            --hidden-import=core \
            --hidden-import=core.novel_downloader \
            --hidden-import=core.cli \
            --hidden-import=packaging \
            --hidden-import=packaging.version \
            --hidden-import=tempfile \
            --hidden-import=json \
            --hidden-import=time \
            --collect-data fake_useragent \
            --collect-submodules aiohttp \
            --collect-submodules asyncio \
            main.py
        shell: bash

      - name: Verify build
        run: |
          ls -la dist/
          target="dist/${{ matrix.executable }}${{ matrix.ext }}"
          if [ -f "$target" ]; then
            echo "[OK] Build successful: $(basename "$target")"
            echo "File size: $(ls -lh "$target" | awk '{print $5}')"
          else
            echo "[X] Build failed: $(basename "$target") not found"
            exit 1
          fi
        shell: bash

      - name: Test executable (non-GUI variants)
        if: matrix.variant != 'release' && matrix.variant != 'release-standalone'
        run: |
          target="dist/${{ matrix.executable }}${{ matrix.ext }}"
            echo "[TEST] Testing executable: $target"

          # è¿è¡ŒåŸºæœ¬æµ‹è¯•ï¼ˆè¶…æ—¶30ç§’ï¼‰
          timeout 30s "$target" --help || echo "Help command test completed"

          echo "[OK] Executable test completed"
        shell: bash

      - name: Rename for release
        run: |
          SRC="dist/${{ matrix.executable }}${{ matrix.ext }}"
          DST="dist/${{ matrix.release_name }}"
          if [ "$SRC" != "$DST" ]; then
            cp "$SRC" "$DST"
          else
            echo "Source and destination are the same, skipping copy"
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.release_name }}
          if-no-files-found: error

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: dist/${{ matrix.release_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build completed
        run: echo "âœ… Build and artifact prepared for ${{ matrix.variant }}"

  # Termux ARM64 å‘½ä»¤è¡Œç‰ˆæœ¬æ„å»º
  build-termux:
    needs: [prepare-release]
    if: needs.prepare-release.result == 'success'
    runs-on: ubuntu-latest
    name: Termux ARM64 CLI

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Update version.py
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          BUILD_TIME="${{ needs.prepare-release.outputs.build_time }}"
          
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"POf-L/Fanqie-novel-Downloader\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"github-actions-termux\"" >> version.py

      - name: Build Termux ARM64 binary
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          install: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -q
            # Install build dependencies for Pillow, cffi, and others
            apt-get install -y python3 python3-pip python3-venv python3-dev binutils git build-essential patchelf \
              libjpeg-dev zlib1g-dev libfreetype6-dev liblcms2-dev libopenjp2-7-dev libtiff-dev tk-dev tcl-dev \
              libffi-dev libssl-dev libwebp-dev libxml2-dev libxslt-dev wget file
            # å®‰è£…æ–°ç‰ˆ CMake (3.28+) å› ä¸º termux-elf-cleaner éœ€è¦ 3.25+
            wget -q https://github.com/Kitware/CMake/releases/download/v3.28.3/cmake-3.28.3-linux-aarch64.tar.gz
            tar -xzf cmake-3.28.3-linux-aarch64.tar.gz -C /opt
            ln -sf /opt/cmake-3.28.3-linux-aarch64/bin/cmake /usr/local/bin/cmake
            rm cmake-3.28.3-linux-aarch64.tar.gz
            cmake --version
            # ä»æºç ç¼–è¯‘å®‰è£… termux-elf-cleaner
            git clone https://github.com/termux/termux-elf-cleaner.git /tmp/termux-elf-cleaner
            cd /tmp/termux-elf-cleaner
            mkdir build
            cd build
            cmake ..
            make
            cp termux-elf-cleaner /usr/local/bin/
            cd /
            rm -rf /tmp/termux-elf-cleaner
            # éªŒè¯ termux-elf-cleaner å®‰è£…
            termux-elf-cleaner --version || echo "termux-elf-cleaner version check failed"
          run: |
            cd /workspace
            
            # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ– ARM64 ç¼–è¯‘
            export CFLAGS="-O2"
            export CXXFLAGS="-O2"
            export LDFLAGS="-Wl,--as-needed"
            
            python3 -m venv venv --system-site-packages
            . venv/bin/activate
            
            # Upgrade build tools
            pip install --upgrade pip setuptools wheel
            
            # Install dependencies with extended timeout and binary preference
            # Try to find manylinux_aarch64 wheels to avoid compilation on QEMU
            pip install --default-timeout=3600 --prefer-binary -r config/requirements-termux.txt
            pip install --default-timeout=3600 --prefer-binary pyinstaller
            
            # æ„å»ºå‘½ä»¤è¡Œç‰ˆæœ¬ (ä½¿ç”¨ novel_downloader.py ä½œä¸ºå…¥å£)
            pyinstaller --onefile \
              --name=TomatoNovelDownloader-termux \
              --console \
              --icon=assets/icons/icon_256.png \
              --add-data "config/fanqie.json:." \
              --hidden-import=requests \
              --hidden-import=aiohttp \
              --hidden-import=asyncio \
              --hidden-import=concurrent.futures \
              --hidden-import=threading \
              --hidden-import=PIL \
              --hidden-import=ebooklib \
              --hidden-import=fake_useragent \
              --hidden-import=tqdm \
              --hidden-import=bs4 \
              --hidden-import=config \
              --hidden-import=config.config \
              --hidden-import=version \
              --hidden-import=utils \
              --hidden-import=utils.encoding_utils \
              --hidden-import=utils.packaging_fixes \
              --hidden-import=utils.updater \
              --hidden-import=utils.watermark \
              --hidden-import=utils.async_logger \
              --hidden-import=utils.messages \
              --hidden-import=utils.runtime_bootstrap \
              --hidden-import=utils.node_manager \
              --hidden-import=core \
              --hidden-import=core.novel_downloader \
              --hidden-import=packaging \
              --hidden-import=packaging.version \
              --hidden-import=tempfile \
              --hidden-import=json \
              --hidden-import=time \
              --collect-data fake_useragent \
              --collect-submodules PIL \
              --collect-submodules aiohttp \
              --collect-submodules asyncio \
              --strip \
              core/novel_downloader.py
            
            # éªŒè¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
            echo "=== æ£€æŸ¥ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ ==="
            ls -la dist/
            file dist/TomatoNovelDownloader-termux
            ldd dist/TomatoNovelDownloader-termux || echo "ldd failed - checking with readelf"
            readelf -d dist/TomatoNovelDownloader-termux | head -20 || echo "readelf failed"
            
            # ä½¿ç”¨ termux-elf-cleaner ä¿®å¤ ELF è§£é‡Šå™¨è·¯å¾„å’Œ RPATH
            echo "=== åº”ç”¨ termux-elf-cleaner ==="
            termux-elf-cleaner dist/TomatoNovelDownloader-termux || echo "termux-elf-cleaner warning (non-fatal)"
            
            # å†æ¬¡éªŒè¯ä¿®å¤åçš„äºŒè¿›åˆ¶æ–‡ä»¶
            echo "=== éªŒè¯ä¿®å¤åçš„äºŒè¿›åˆ¶æ–‡ä»¶ ==="
            file dist/TomatoNovelDownloader-termux
            ldd dist/TomatoNovelDownloader-termux || echo "ldd still failed after cleaning"
            
            # æ£€æŸ¥å¯æ‰§è¡Œæƒé™
            chmod +x dist/TomatoNovelDownloader-termux
            
            # åœ¨å®¹å™¨å†…å®Œæˆé‡å‘½åï¼Œé¿å…æƒé™é—®é¢˜
            cp dist/TomatoNovelDownloader-termux dist/TomatoNovelDownloader-termux-arm64
            chmod +x dist/TomatoNovelDownloader-termux-arm64 || true
            ls -la dist/

      - name: Verify Termux build
        run: |
          ls -la dist/
          if [ -f "dist/TomatoNovelDownloader-termux" ]; then
            echo "[OK] Termux ARM64 build successful"
            file dist/TomatoNovelDownloader-termux
            echo "File size: $(ls -lh dist/TomatoNovelDownloader-termux | awk '{print $5}')"
            
            # æ£€æŸ¥å¯æ‰§è¡Œæƒé™
            if [ -x "dist/TomatoNovelDownloader-termux" ]; then
              echo "[OK] Executable permissions set correctly"
            else
              echo "[X] Executable permissions missing"
              chmod +x dist/TomatoNovelDownloader-termux
            fi
            
            # æ£€æŸ¥é‡å‘½åçš„æ–‡ä»¶
            if [ -f "dist/TomatoNovelDownloader-termux-arm64" ]; then
              echo "[OK] ARM64 renamed file exists"
              file dist/TomatoNovelDownloader-termux-arm64
              # ç¡®ä¿é‡å‘½åçš„æ–‡ä»¶ä¹Ÿæœ‰æ‰§è¡Œæƒé™
              chmod +x dist/TomatoNovelDownloader-termux-arm64 || true
            else
              echo "[X] ARM64 renamed file missing"
              exit 1
            fi
          else
            echo "[X] Termux build failed"
            exit 1
          fi

      - name: Upload Termux artifact
        uses: actions/upload-artifact@v4
        with:
          name: TomatoNovelDownloader-termux-arm64
          path: dist/TomatoNovelDownloader-termux-arm64
          if-no-files-found: error

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: dist/TomatoNovelDownloader-termux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Termux build completed
        run: echo "âœ… Termux ARM64 build completed"

  # æ‰€æœ‰æ„å»ºå®Œæˆåæ›´æ–° Release ä¿¡æ¯
  finalize-release:
    name: Finalize Release
    if: always() && github.event_name != 'pull_request' && needs.prepare-release.result == 'success'
    needs: [prepare-release, build, build-termux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog since latest release
        id: changelog
        shell: bash
        run: |
          set -e

          LATEST_TAG=$(curl -fsSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('tag_name',''))" || true)

          if [ -n "$LATEST_TAG" ]; then
            RANGE="$LATEST_TAG..${{ github.sha }}"
          else
            RANGE="${{ github.sha }}~50..${{ github.sha }}"
          fi

          CHANGELOG=$(git log $RANGE --pretty=format:'- `%h` %s' || true)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- æ— æ–°çš„æäº¤è®°å½•"
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: 'TomatoNovelDownloader-*'
          merge-multiple: true

      - name: Generate runtime manifest
        run: |
          python scripts/generate_update_manifest.py \
            --repo "${{ github.repository }}" \
            --ref "${{ needs.prepare-release.outputs.tag_name }}" \
            --release-tag "${{ needs.prepare-release.outputs.tag_name }}" \
            --output "runtime-manifest.json"
          ls -la runtime-manifest.json
        shell: bash

      - name: Upload runtime manifest to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: runtime-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List all artifacts
        run: |
          ls -laR dist/
          echo "Total size: $(du -sh dist/)"

      - name: Check build results
        id: check_builds
        run: |
          echo "Build job result: ${{ needs.build.result }}"
          echo "Termux job result: ${{ needs.build-termux.result }}"
          
          # åˆ¤æ–­æ˜¯å¦å…¨éƒ¨æˆåŠŸ
          ALL_SUCCESS="true"
          BUILD_STATUS=""
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            BUILD_STATUS="[OK] ä¸»æ„å»ºå®Œæˆ"
          else
            BUILD_STATUS="[!] ä¸»æ„å»ºéƒ¨åˆ†å¤±è´¥"
            ALL_SUCCESS="false"
          fi
          
          if [ "${{ needs.build-termux.result }}" == "success" ]; then
            BUILD_STATUS="$BUILD_STATUS | [OK] Termux æ„å»ºå®Œæˆ"
          else
            BUILD_STATUS="$BUILD_STATUS | [!] Termux æ„å»ºå¤±è´¥"
            ALL_SUCCESS="false"
          fi
          
          echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          echo "all_success=$ALL_SUCCESS" >> $GITHUB_OUTPUT

      - name: Update Release (all builds successful)
        if: steps.check_builds.outputs.all_success == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: TomatoNovelDownloader ${{ needs.prepare-release.outputs.tag_name }}
          body: |
            ## ğŸ‰ TomatoNovelDownloader ${{ needs.prepare-release.outputs.tag_name }}

            ### ğŸ“ æ›´æ–°å†…å®¹ï¼ˆè‡ªä¸Šä¸€ä¸ª Latest ç‰ˆæœ¬èµ·ï¼‰

            ${{ steps.changelog.outputs.content }}

            ---

            ### ğŸ“¥ ä¸‹è½½é€šé“
            
            | å¹³å° | æ¨èæ–‡ä»¶ | è¯´æ˜ |
            | :--- | :--- | :--- |
            | **ğŸªŸ Windows** | `...Standalone.exe` | âœ… **é¦–é€‰** (å†…ç½®è¿è¡Œåº“ï¼Œå¼€ç®±å³ç”¨) |
            | | `TomatoNovelDownloader.exe` | çº¯å‡€ç‰ˆ (éœ€è‡ªå¤‡ WebView2) |
            | **ğŸ§ Linux** | `...linux` | x64 æ¶æ„ (éœ€å®‰è£… GTK3/WebKit) |
            | **ğŸ macOS** | `...macos` | Intel èŠ¯ç‰‡ (x64) |
            | **ğŸ¤– Termux** | `...termux-arm64` | Android Termux å‘½ä»¤è¡Œç‰ˆ |
            
            ---
            
            ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            | :--- | :--- |
            | ğŸ•’ **å‘å¸ƒæ—¶é—´** | ${{ needs.prepare-release.outputs.build_time }} |
            | ğŸ·ï¸ **å¯¹æ¯”èµ·ç‚¹** | `${{ steps.changelog.outputs.latest_tag }}` |
            | ğŸ”— **Commit** | `${{ github.sha }}` |
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Release (some builds failed)
        if: steps.check_builds.outputs.all_success != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: "[!] TomatoNovelDownloader ${{ needs.prepare-release.outputs.tag_name }} (éƒ¨åˆ†æ„å»º)"
          body: |
            ## [!] TomatoNovelDownloader ${{ needs.prepare-release.outputs.tag_name }}
            
            ### ğŸ“ æ›´æ–°å†…å®¹ï¼ˆè‡ªä¸Šä¸€ä¸ª Latest ç‰ˆæœ¬èµ·ï¼‰

            ${{ steps.changelog.outputs.content }}

            ---
            
            ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            | :--- | :--- |
            | ğŸ•’ **å‘å¸ƒæ—¶é—´** | ${{ needs.prepare-release.outputs.build_time }} |
            | ğŸ·ï¸ **å¯¹æ¯”èµ·ç‚¹** | `${{ steps.changelog.outputs.latest_tag }}` |
            | ğŸ”— **Commit** | `${{ github.sha }}` |
          draft: false
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
