name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ç”Ÿæˆç‰ˆæœ¬å·çš„job
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_time: ${{ steps.version.outputs.BUILD_TIME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate version
        id: version
        run: |
          VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
          echo "Build time: $BUILD_TIME"

  build:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows å‘å¸ƒç‰ˆ
          - os: windows-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: .exe
            artifact_name: TomatoNovelDownloader-windows-x64
            build_flags: '--windowed'
          # Windows è°ƒè¯•ç‰ˆ
          - os: windows-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: .exe
            artifact_name: TomatoNovelDownloader-debug-windows-x64
            build_flags: '--console'
          # Windows Standalone (å†…ç½® WebView2)
          - os: windows-latest
            variant: release-standalone
            executable: TomatoNovelDownloader-Standalone
            ext: .exe
            artifact_name: TomatoNovelDownloader-standalone-windows-x64
            build_flags: '--windowed --add-data "WebView2;WebView2"'
          # Linux å‘å¸ƒç‰ˆ
          - os: ubuntu-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: ''
            artifact_name: TomatoNovelDownloader-linux-x64
            build_flags: '--windowed'
          # Linux è°ƒè¯•ç‰ˆ
          - os: ubuntu-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: ''
            artifact_name: TomatoNovelDownloader-debug-linux-x64
            build_flags: '--console'
          # macOS å‘å¸ƒç‰ˆ
          - os: macos-latest
            variant: release
            executable: TomatoNovelDownloader
            ext: ''
            artifact_name: TomatoNovelDownloader-macos-x64
            build_flags: '--windowed'
          # macOS è°ƒè¯•ç‰ˆ
          - os: macos-latest
            variant: debug
            executable: TomatoNovelDownloader-debug
            ext: ''
            artifact_name: TomatoNovelDownloader-debug-macos-x64
            build_flags: '--console'

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - ${{ matrix.variant }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libheif1 libheif-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libheif || true

      - name: Update version.py
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          BUILD_TIME="${{ needs.version.outputs.build_time }}"
          echo "Using version: $VERSION"
          echo "Using build time: $BUILD_TIME"
          
          # å®Œå…¨é‡å†™version.pyæ–‡ä»¶ï¼Œç¡®ä¿__build_channel__æ­£ç¡®è®¾ç½®
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"POf-L/Fanqie-novel-Downloader\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"github-actions\"" >> version.py
          
          echo "âœ… æ›´æ–°åçš„version.py:"
          cat version.py
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install --prefer-binary pyinstaller
        shell: bash

      - name: Download WebView2 Runtime (Standalone only)
        if: matrix.variant == 'release-standalone'
        run: |
          # ä¸‹è½½ WebView2 Fixed Version Runtime (é€šè¿‡ NuGet åŒ…è·å–)
          curl -L -o webview2.zip "https://www.nuget.org/api/v2/package/WebView2.Runtime.X64/129.0.2792.52"
          7z x webview2.zip -oWebView2Temp
          
          # æŸ¥æ‰¾åŒ…å« msedgewebview2.exe çš„æ–‡ä»¶å¤¹
          TARGET_DIR=$(find WebView2Temp -name "msedgewebview2.exe" | head -n 1 | xargs dirname)
          
          if [ -z "$TARGET_DIR" ]; then
            echo "Error: Could not find msedgewebview2.exe in package"
            # å°è¯•åˆ—å‡ºæ–‡ä»¶ä»¥ä¾›è°ƒè¯•
            find WebView2Temp
            exit 1
          fi
          
          echo "Found runtime at $TARGET_DIR"
          # ç§»åŠ¨åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ WebView2 æ–‡ä»¶å¤¹
          mv "$TARGET_DIR" ./WebView2
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf WebView2Temp webview2.zip
          
          echo "âœ… WebView2 Runtime prepared"
        shell: bash

      - name: Build application (${{ matrix.variant }})
        run: |
          python -m PyInstaller --onefile \
            --name=${{ matrix.executable }} \
            ${{ matrix.build_flags }} \
            --add-data "static:static" \
            --add-data "templates:templates" \
            --hidden-import=flask \
            --hidden-import=flask_cors \
            --hidden-import=pywebview \
            --hidden-import=PIL \
            --hidden-import=requests \
            --hidden-import=aiohttp \
            --hidden-import=beautifulsoup4 \
            --hidden-import=ebooklib \
            --hidden-import=fake_useragent \
            --hidden-import=config \
            --hidden-import=updater \
            --hidden-import=packaging \
            --hidden-import=packaging.version \
            --collect-data fake_useragent \
            main.py
        shell: bash

      - name: Verify build
        run: |
          ls -la dist/
          target="dist/${{ matrix.executable }}${{ matrix.ext }}"
          if [ -f "$target" ]; then
            echo "âœ… Build successful: $(basename "$target")"
            echo "File size: $(ls -lh "$target" | awk '{print $5}')"
          else
            echo "âŒ Build failed: $(basename "$target") not found"
            exit 1
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.executable }}${{ matrix.ext }}
          if-no-files-found: error

  # Termux ARM64 å‘½ä»¤è¡Œç‰ˆæœ¬æ„å»º
  build-termux:
    needs: version
    runs-on: ubuntu-latest
    name: Termux ARM64 CLI

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Update version.py
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          BUILD_TIME="${{ needs.version.outputs.build_time }}"
          
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"POf-L/Fanqie-novel-Downloader\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"github-actions-termux\"" >> version.py

      - name: Build Termux ARM64 binary
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          install: |
            apt-get update -q
            apt-get install -y python3 python3-pip python3-venv binutils
          run: |
            cd /workspace
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements-termux.txt
            pip install pyinstaller
            
            # æ„å»ºå‘½ä»¤è¡Œç‰ˆæœ¬ (ä½¿ç”¨ novel_downloader.py ä½œä¸ºå…¥å£)
            pyinstaller --onefile \
              --name=TomatoNovelDownloader-termux \
              --console \
              --hidden-import=requests \
              --hidden-import=aiohttp \
              --hidden-import=PIL \
              --hidden-import=ebooklib \
              --hidden-import=fake_useragent \
              --hidden-import=tqdm \
              --hidden-import=bs4 \
              --hidden-import=config \
              --hidden-import=packaging \
              --hidden-import=packaging.version \
              --collect-data fake_useragent \
              novel_downloader.py
            
            ls -la dist/

      - name: Verify Termux build
        run: |
          ls -la dist/
          if [ -f "dist/TomatoNovelDownloader-termux" ]; then
            echo "âœ… Termux ARM64 build successful"
            file dist/TomatoNovelDownloader-termux
            echo "File size: $(ls -lh dist/TomatoNovelDownloader-termux | awk '{print $5}')"
          else
            echo "âŒ Termux build failed"
            exit 1
          fi

      - name: Upload Termux artifact
        uses: actions/upload-artifact@v4
        with:
          name: TomatoNovelDownloader-termux-arm64
          path: dist/TomatoNovelDownloader-termux
          if-no-files-found: error

  release:
    name: Create Release
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    needs: [version, build, build-termux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # å¤åˆ¶Windowsæ–‡ä»¶ï¼ˆä¿æŒåŸåï¼‰
          if [ -d "artifacts/TomatoNovelDownloader-windows-x64" ]; then
            cp artifacts/TomatoNovelDownloader-windows-x64/TomatoNovelDownloader.exe release/
          fi
          if [ -d "artifacts/TomatoNovelDownloader-debug-windows-x64" ]; then
            cp artifacts/TomatoNovelDownloader-debug-windows-x64/TomatoNovelDownloader-debug.exe release/
          fi
          if [ -d "artifacts/TomatoNovelDownloader-standalone-windows-x64" ]; then
            cp artifacts/TomatoNovelDownloader-standalone-windows-x64/TomatoNovelDownloader-Standalone.exe release/
          fi
          
          # å¤åˆ¶Linuxæ–‡ä»¶ï¼ˆé‡å‘½åä»¥åŒ…å«å¹³å°ä¿¡æ¯ï¼‰
          if [ -d "artifacts/TomatoNovelDownloader-linux-x64" ]; then
            cp artifacts/TomatoNovelDownloader-linux-x64/TomatoNovelDownloader release/TomatoNovelDownloader-linux
          fi
          if [ -d "artifacts/TomatoNovelDownloader-debug-linux-x64" ]; then
            cp artifacts/TomatoNovelDownloader-debug-linux-x64/TomatoNovelDownloader-debug release/TomatoNovelDownloader-debug-linux
          fi
          
          # å¤åˆ¶macOSæ–‡ä»¶ï¼ˆé‡å‘½åä»¥åŒ…å«å¹³å°ä¿¡æ¯ï¼‰
          if [ -d "artifacts/TomatoNovelDownloader-macos-x64" ]; then
            cp artifacts/TomatoNovelDownloader-macos-x64/TomatoNovelDownloader release/TomatoNovelDownloader-macos
          fi
          if [ -d "artifacts/TomatoNovelDownloader-debug-macos-x64" ]; then
            cp artifacts/TomatoNovelDownloader-debug-macos-x64/TomatoNovelDownloader-debug release/TomatoNovelDownloader-debug-macos
          fi
          
          # å¤åˆ¶Termux ARM64æ–‡ä»¶
          if [ -d "artifacts/TomatoNovelDownloader-termux-arm64" ]; then
            cp artifacts/TomatoNovelDownloader-termux-arm64/TomatoNovelDownloader-termux release/TomatoNovelDownloader-termux-arm64
          fi
          
          echo "ğŸ“¦ Release files prepared:"
          ls -lh release/
        shell: bash

      - name: Determine release version
        id: release_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # ä½¿ç”¨æ ‡ç­¾åç§°ï¼ˆå»æ‰ refs/tags/ å‰ç¼€ï¼‰
            VERSION="${{ github.ref_name }}"
            echo "ä½¿ç”¨æ ‡ç­¾ç‰ˆæœ¬: $VERSION"
          else
            # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬å·
            VERSION="v${{ needs.version.outputs.version }}"
            echo "ä½¿ç”¨è‡ªåŠ¨ç‰ˆæœ¬: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_version.outputs.version }}
          name: TomatoNovelDownloader ${{ steps.release_version.outputs.version }}
          generate_release_notes: true
          body: |
            ## ğŸ“¦ Release ${{ steps.release_version.outputs.version }}
            
            ### æäº¤ä¿¡æ¯
            ${{ github.event.head_commit.message }}
            
            ### æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: ${{ needs.version.outputs.build_time }}
            - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            
            ### ğŸ“‚ ä¸‹è½½æ–‡ä»¶è¯´æ˜
            
            #### ğŸ¯ å‘å¸ƒç‰ˆæœ¬ (æ¨è)
            - ğŸ’» **Windows (x64)**: `TomatoNovelDownloader.exe` (éœ€ç³»ç»Ÿå·²å®‰è£… WebView2)
            - ğŸ“¦ **Windows (å†…ç½® WebView2)**: `TomatoNovelDownloader-Standalone.exe` (ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€é…ç½®)
            - ğŸ§ **Linux (x64)**: `TomatoNovelDownloader-linux`
            - ğŸ **macOS (x64)**: `TomatoNovelDownloader-macos`
            
            > å‘å¸ƒç‰ˆæ— æ§åˆ¶å°çª—å£ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
            
            #### ğŸ”§ è°ƒè¯•ç‰ˆæœ¬ (å¼€å‘/è°ƒè¯•ç”¨)
            - ğŸ’» **Windows (x64)**: `TomatoNovelDownloader-debug.exe`
            - ğŸ§ **Linux (x64)**: `TomatoNovelDownloader-debug-linux`
            - ğŸ **macOS (x64)**: `TomatoNovelDownloader-debug-macos`
            
            #### ğŸ“± Termux å‘½ä»¤è¡Œç‰ˆæœ¬ (Android)
            - ğŸ¤– **Termux (ARM64)**: `TomatoNovelDownloader-termux-arm64`
            
            > Termux ç‰ˆæœ¬ä¸ºçº¯å‘½ä»¤è¡Œäº¤äº’å¼ç‰ˆæœ¬ï¼Œæ—  GUI ä¾èµ–ï¼Œé€‚åˆåœ¨ Android æ‰‹æœºä¸Šé€šè¿‡ Termux ä½¿ç”¨
            
          files: release/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}