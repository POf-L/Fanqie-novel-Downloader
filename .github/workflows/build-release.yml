name: Build and Release

on:
  workflow_dispatch:
    inputs:
      build_launcher:
        description: "æ˜¯å¦é‡æ–°æ„å»º Launcherï¼ˆé€šå¸¸ä¸º falseï¼‰"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare-release:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_time: ${{ steps.version.outputs.BUILD_TIME }}
      tag_name: ${{ steps.version.outputs.TAG_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        shell: bash
        run: |
          VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          TAG_NAME="v$VERSION"

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}"
          body: |
            ## ğŸš€ TomatoNovelDownloader ${{ steps.version.outputs.TAG_NAME }}

            ### ğŸ“¦ å‘å¸ƒæ¨¡å¼
            - ç¨³å®š Launcher + äº‘ç«¯ Runtime
            - Runtime åŒ…å«ä»£ç ä¸ä¾èµ–

            ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            | :--- | :--- |
            | ğŸ•’ **å‘å¸ƒæ—¶é—´** | ${{ steps.version.outputs.BUILD_TIME }} |
            | ğŸ”© **Commit** | `${{ github.sha }}` |

            ### ğŸ“¥ ä¸‹è½½å…¥å£
            - ç¨³å®šå¯åŠ¨å™¨ï¼ˆé•¿æœŸå›ºå®šï¼‰ï¼šhttps://github.com/${{ github.repository }}/releases/tag/launcher-stable
            - æœ¬æ¬¡ Runtime èµ„äº§ï¼šåœ¨æœ¬æ¡ Release çš„ Assets ä¸­ä¸‹è½½
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-launcher:
    needs: [prepare-release]
    if: needs.prepare-release.result == 'success' && github.event_name == 'workflow_dispatch' && inputs.build_launcher == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            launcher_name: FanqieLauncher-windows-x64.exe
            sep: ';'
            icon_arg: '--icon=assets/icons/icon.ico'
          - os: ubuntu-latest
            platform: linux-x64
            launcher_name: FanqieLauncher-linux-x64
            sep: ':'
            icon_arg: ''
          - os: macos-latest
            platform: macos-x64
            launcher_name: FanqieLauncher-macos-x64
            sep: ':'
            icon_arg: ''
    runs-on: ${{ matrix.os }}
    name: Build Launcher
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: config/requirements.txt

      - name: Install build dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller requests

      - name: Set default repo in launcher
        shell: bash
        run: |
          sed -i 's|POf-L/Fanqie-novel-Downloader|${{ github.repository }}|g' launcher.py

      - name: Build launcher executable
        shell: bash
        run: |
          python -m PyInstaller --onefile \
            --name="${{ matrix.launcher_name }}" \
            --console \
            --add-data "assets${{ matrix.sep }}assets" \
            --hidden-import=requests \
            ${{ matrix.icon_arg }} \
            launcher.py

      - name: Upload launcher artifact
        uses: actions/upload-artifact@v4
        with:
          name: launcher-${{ matrix.platform }}
          path: dist/${{ matrix.launcher_name }}
          if-no-files-found: error

      - name: Upload launcher to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: dist/${{ matrix.launcher_name }}
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload launcher to stable channel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: launcher-stable
          name: FanqieLauncher Stable
          body: |
            ## FanqieLauncher Stable
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„Launcherï¼ˆæ— éœ€å®‰è£…Pythonï¼‰
            2. è¿è¡ŒLauncherï¼Œè‡ªåŠ¨ä¸‹è½½æœ€æ–°Runtime
            3. äº«å—å®Œæ•´çš„å°è¯´ä¸‹è½½åŠŸèƒ½
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            - **Windows**: `FanqieLauncher-windows-x64.exe`
            - **Linux**: `FanqieLauncher-linux-x64`
            - **macOS**: `FanqieLauncher-macos-x64`
            
            ### ğŸ’¡ ç‰¹æ€§
            - æ— éœ€å®‰è£…Pythonç¯å¢ƒ
            - è‡ªåŠ¨æ›´æ–°å’Œä¾èµ–ç®¡ç†
            - è·¨å¹³å°æ”¯æŒ
            - ç¾è§‚çš„TUIç•Œé¢
          draft: false
          prerelease: false
          make_latest: true
          files: dist/${{ matrix.launcher_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-runtime:
    needs: [prepare-release]
    if: needs.prepare-release.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            runtime_name: runtime-windows-x64.zip
          - os: ubuntu-latest
            platform: linux-x64
            runtime_name: runtime-linux-x64.zip
          - os: macos-latest
            platform: macos-x64
            runtime_name: runtime-macos-x64.zip
    runs-on: ${{ matrix.os }}
    name: Build Runtime (${{ matrix.platform }})
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: config/requirements.txt

      - name: Install runtime dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install --prefer-binary -r config/requirements.txt

      - name: Generate runtime version.py
        shell: bash
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          BUILD_TIME="${{ needs.prepare-release.outputs.build_time }}"
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"${{ github.repository }}\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"launcher-runtime\"" >> version.py

      - name: Build runtime package
        shell: bash
        run: |
          rm -rf runtime
          mkdir -p runtime

          cp -r assets runtime/
          cp -r config runtime/
          cp -r core runtime/
          cp -r utils runtime/
          cp -r web runtime/
          cp main.py runtime/
          if [ -f version.py ]; then cp version.py runtime/; fi

          python -m venv runtime/.venv
          if [ "${{ runner.os }}" = "Windows" ]; then
            runtime/.venv/Scripts/python -m pip install --upgrade pip
            runtime/.venv/Scripts/python -m pip install --prefer-binary -r config/requirements.txt
          else
            runtime/.venv/bin/python -m pip install --upgrade pip
            runtime/.venv/bin/python -m pip install --prefer-binary -r config/requirements.txt
          fi

          cd runtime
          python - <<'PY'
          import os, zipfile
          out_name = os.environ['RUNTIME_NAME']
          with zipfile.ZipFile(f"../{out_name}", "w", zipfile.ZIP_DEFLATED) as z:
              for root, _, files in os.walk("."):
                  for file in files:
                      full = os.path.join(root, file)
                      rel = os.path.relpath(full, ".")
                      z.write(full, rel)
          PY
        env:
          RUNTIME_NAME: ${{ matrix.runtime_name }}

      - name: Generate runtime manifest
        shell: bash
        run: |
          python - <<'PY'
          import hashlib
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          runtime_path = Path(os.environ["RUNTIME_FILE"]).resolve()
          output_path = Path(os.environ["OUTPUT_FILE"]).resolve()

          if not runtime_path.exists():
              raise FileNotFoundError(f"Runtime file not found: {runtime_path}")

          hasher = hashlib.sha256()
          with runtime_path.open("rb") as file_obj:
              while True:
                  chunk = file_obj.read(1024 * 1024)
                  if not chunk:
                      break
                  hasher.update(chunk)

          manifest = {
              "manifest_version": "1",
              "platform": os.environ["PLATFORM"],
              "runtime_version": os.environ["TAG_NAME"],
              "runtime_archive_name": runtime_path.name,
              "runtime_archive_url": f"https://github.com/{os.environ['REPO_NAME']}/releases/download/{os.environ['TAG_NAME']}/{runtime_path.name}",
              "runtime_archive_sha256": hasher.hexdigest(),
              "runtime_archive_size": runtime_path.stat().st_size,
              "min_launcher_version": "1.0.0",
              "generated_at": datetime.now(timezone.utc).isoformat(),
          }

          output_path.parent.mkdir(parents=True, exist_ok=True)
          with output_path.open("w", encoding="utf-8") as file_obj:
              json.dump(manifest, file_obj, ensure_ascii=False, indent=2)

          print(f"generated: {output_path}")
          PY
        env:
          REPO_NAME: ${{ github.repository }}
          TAG_NAME: ${{ needs.prepare-release.outputs.tag_name }}
          PLATFORM: ${{ matrix.platform }}
          RUNTIME_FILE: ${{ matrix.runtime_name }}
          OUTPUT_FILE: runtime-manifest-${{ matrix.platform }}.json

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ matrix.platform }}
          path: ${{ matrix.runtime_name }}
          if-no-files-found: error

      - name: Upload runtime manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-manifest-${{ matrix.platform }}
          path: runtime-manifest-${{ matrix.platform }}.json
          if-no-files-found: error

      - name: Upload runtime and manifest to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: |
            ${{ matrix.runtime_name }}
            runtime-manifest-${{ matrix.platform }}.json
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-runtime-termux:
    needs: [prepare-release]
    if: needs.prepare-release.result == 'success'
    runs-on: ubuntu-latest
    name: Build Runtime (termux-arm64)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Generate termux runtime version.py
        shell: bash
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          BUILD_TIME="${{ needs.prepare-release.outputs.build_time }}"
          echo "# -*- coding: utf-8 -*-" > version.py
          echo '"""' >> version.py
          echo "ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> version.py
          echo '"""' >> version.py
          echo "" >> version.py
          echo "__version__ = \"$VERSION\"" >> version.py
          echo "__author__ = \"Tomato Novel Downloader\"" >> version.py
          echo "__description__ = \"A modern novel downloader with GitHub auto-update support\"" >> version.py
          echo "__github_repo__ = \"${{ github.repository }}\"" >> version.py
          echo "__build_time__ = \"$BUILD_TIME\"" >> version.py
          echo "__build_channel__ = \"launcher-runtime-termux\"" >> version.py

      - name: Build termux runtime package with dependencies
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          install: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -q
            apt-get install -y python3 python3-pip python3-venv python3-dev build-essential \
              libffi-dev libssl-dev libjpeg-dev zlib1g-dev libxml2-dev libxslt-dev zip
          run: |
            cd /workspace
            rm -rf runtime-termux
            mkdir -p runtime-termux

            cp -r assets runtime-termux/
            cp -r config runtime-termux/
            cp -r core runtime-termux/
            cp -r utils runtime-termux/
            cp -r web runtime-termux/
            cp main.py runtime-termux/
            if [ -f version.py ]; then cp version.py runtime-termux/; fi

            python3 -m venv runtime-termux/.venv
            runtime-termux/.venv/bin/python -m pip install --upgrade pip
            runtime-termux/.venv/bin/python -m pip install --default-timeout=3600 --prefer-binary -r config/requirements-termux.txt

            cd runtime-termux
            zip -r ../runtime-termux-arm64.zip .

      - name: Generate termux runtime manifest
        shell: bash
        run: |
          python - <<'PY'
          import hashlib
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          runtime_path = Path("runtime-termux-arm64.zip").resolve()
          output_path = Path("runtime-manifest-termux-arm64.json").resolve()

          if not runtime_path.exists():
              raise FileNotFoundError(f"Runtime file not found: {runtime_path}")

          hasher = hashlib.sha256()
          with runtime_path.open("rb") as file_obj:
              while True:
                  chunk = file_obj.read(1024 * 1024)
                  if not chunk:
                      break
                  hasher.update(chunk)

          manifest = {
              "manifest_version": "1",
              "platform": "termux-arm64",
              "runtime_version": os.environ["TAG_NAME"],
              "runtime_archive_name": runtime_path.name,
              "runtime_archive_url": f"https://github.com/{os.environ['REPO_NAME']}/releases/download/{os.environ['TAG_NAME']}/{runtime_path.name}",
              "runtime_archive_sha256": hasher.hexdigest(),
              "runtime_archive_size": runtime_path.stat().st_size,
              "min_launcher_version": "1.0.0",
              "generated_at": datetime.now(timezone.utc).isoformat(),
          }

          with output_path.open("w", encoding="utf-8") as file_obj:
              json.dump(manifest, file_obj, ensure_ascii=False, indent=2)

          print(f"generated: {output_path}")
          PY
        env:
          REPO_NAME: ${{ github.repository }}
          TAG_NAME: ${{ needs.prepare-release.outputs.tag_name }}

      - name: Prepare termux launcher asset
        shell: bash
        run: |
          cp scripts/termux_launcher.sh TomatoNovelDownloader-termux-arm64
          chmod +x TomatoNovelDownloader-termux-arm64

      - name: Upload termux runtime and manifest to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          files: |
            TomatoNovelDownloader-termux-arm64
            runtime-termux-arm64.zip
            runtime-manifest-termux-arm64.json
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize-release:
    name: Finalize Release
    if: always() && needs.prepare-release.result == 'success'
    needs: [prepare-release, build-runtime, build-runtime-termux, build-launcher]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog since latest release
        id: changelog
        shell: bash
        run: |
          set -e

          LATEST_TAG=$(curl -fsSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('tag_name',''))" || true)

          if [ -n "$LATEST_TAG" ]; then
            RANGE="$LATEST_TAG..${{ github.sha }}"
          else
            RANGE="${{ github.sha }}~50..${{ github.sha }}"
          fi

          CHANGELOG=$(git log $RANGE --pretty=format:'- `%h` %s' || true)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- æ— æ–°çš„æäº¤è®°å½•"
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update final release note
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: TomatoNovelDownloader Runtime ${{ needs.prepare-release.outputs.tag_name }}
          body: |
            ## ğŸ“¦ Runtime æ›´æ–°åŒ…
            
            **æ³¨æ„ï¼šè¿™æ˜¯Runtimeæ›´æ–°åŒ…ï¼Œä»…ä¾›Launcherè‡ªåŠ¨æ›´æ–°ä½¿ç”¨ã€‚**
            
            ### ï¿½ å¦‚ä½•ä½¿ç”¨
            1. é¦–æ¬¡ä½¿ç”¨è¯·ä¸‹è½½ [Launcher Stable](https://github.com/${{ github.repository }}/releases/tag/launcher-stable)
            2. è¿è¡ŒLauncherä¼šè‡ªåŠ¨ä¸‹è½½æ­¤Runtime
            3. æ— éœ€æ‰‹åŠ¨ä¸‹è½½Runtimeæ–‡ä»¶
            
            ### ğŸ“ æ›´æ–°å†…å®¹ï¼ˆè‡ªä¸Šä¸€ä¸ªç‰ˆæœ¬èµ·ï¼‰
            ${{ steps.changelog.outputs.content }}
            
            ---
            
            ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            | :--- | :--- |
            | ğŸ•’ **å‘å¸ƒæ—¶é—´** | ${{ needs.prepare-release.outputs.build_time }} |
            | ğŸ”— **æ¯”è¾ƒèµ·ç‚¹** | `${{ steps.changelog.outputs.latest_tag }}` |
            | ğŸ”© **Commit** | `${{ github.sha }}` |
            
            ### ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚
            - Runtimeç‰ˆæœ¬: `${{ needs.prepare-release.outputs.tag_name }}`
            - åŒ…å«å®Œæ•´çš„Pythonç¯å¢ƒå’Œä¾èµ–
            - æ”¯æŒè·¨å¹³å°è‡ªåŠ¨æ›´æ–°
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
