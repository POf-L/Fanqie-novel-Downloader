# Windows更新机制修复说明

## 问题描述

之前的自动更新机制在Windows上存在以下问题：

1. **文件占用问题**：应用程序仍在运行时，批处理脚本无法移动/替换可执行文件
2. **进程退出不完整**：应用程序退出时没有充分等待所有资源释放
3. **缺少错误处理**：批处理脚本缺乏完善的错误处理和日志记录

## 修复内容

### 1. 增强的Windows批处理脚本

**主要改进：**
- 添加进程ID检测，确保旧进程完全退出后再进行文件操作
- 增加文件锁检测机制，确保文件可写后再进行替换
- 添加备份和恢复机制，更新失败时自动恢复
- 完善的日志记录，便于问题排查
- 使用GBK编码确保中文正常显示

**关键特性：**
```batch
REM 等待当前进程完全退出
:wait_process
tasklist /FI "PID eq {current_pid}" 2>nul | find "{current_pid}" >nul
if !errorlevel! == 0 (
    timeout /t 1 /nobreak > nul
    goto wait_process
)

REM 检查目标文件是否被占用
:check_file
copy /y nul "{current_exe}.test" >nul 2>&1
if !errorlevel! == 0 (
    del "{current_exe}.test" >nul 2>&1
    goto file_ready
) else (
    echo [%date% %time%] 文件仍被占用，继续等待...
    timeout /t 2 /nobreak > nul
    goto check_file
)
```

### 2. 优雅的应用程序退出机制

**新增功能：**
- `_graceful_exit()` 方法，确保应用程序优雅退出
- GUI资源清理，包括关闭所有窗口和释放资源
- 使用 `os._exit()` 确保进程立即终止
- 添加退出事件通知机制

### 3. 进程检测和文件锁检测

**新增方法：**
- `_wait_for_process_exit()` - 等待指定进程退出
- `_is_file_locked()` - 检查文件是否被占用
- 支持psutil库进行更精确的进程管理（可选依赖）

### 4. 错误处理和日志记录

**改进内容：**
- 所有操作都有详细的时间戳日志
- 更新日志保存到 `%TEMP%\update.log`
- 失败时显示友好的错误信息
- 自动备份和恢复机制

## 使用方法

### 自动更新流程

1. **检查更新**：应用程序启动时自动检查或手动点击"检查更新"
2. **下载更新**：发现新版本时下载到临时目录
3. **安装更新**：
   - 创建增强的批处理脚本
   - 应用程序优雅退出
   - 批处理脚本等待进程完全退出
   - 检测文件可写性
   - 备份原文件
   - 安装新文件
   - 重启应用程序

### 手动排查

如果更新失败，可以检查以下内容：

1. **更新日志**：查看 `%TEMP%\update.log` 文件
2. **备份文件**：检查是否存在 `.bak` 备份文件
3. **权限问题**：确保应用程序有写入权限
4. **杀毒软件**：检查是否被杀毒软件阻止

## 技术细节

### 依赖更新

添加了新的可选依赖：
```
psutil>=5.9.0,<6.0.0
```

### 兼容性

- **Windows 7+**：支持所有Windows版本
- **编码处理**：批处理脚本使用GBK编码
- **向后兼容**：不影响现有功能

### 安全性

- 文件操作前进行多重检查
- 备份机制防止数据丢失  
- 日志记录便于问题追踪
- 优雅退出避免数据损坏

## 测试建议

1. **正常更新测试**：模拟正常的更新流程
2. **进程占用测试**：在文件被占用时测试更新
3. **权限测试**：在受限权限环境下测试
4. **中断测试**：测试更新过程中的异常中断
5. **恢复测试**：测试失败后的自动恢复功能

这些修复应该能够解决Windows上批量命令行无法移动文件的问题，确保更新过程的可靠性和稳定性。